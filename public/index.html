<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>American Manufacturing 2026</title>
    <link rel="icon" type="image/svg+xml" href="images/favicon.svg">
    <link rel="icon" type="image/png" href="images/favicon.png">
    <script>
        // Set grid dimensions as CSS variables before page renders
        // Define as global constants for use throughout the app
        window.TILE_SIZE = 40;
        window.GRID_W = 35;
        window.GRID_H = 32;
        document.documentElement.style.setProperty('--tile-size', TILE_SIZE);
        document.documentElement.style.setProperty('--grid-w', GRID_W);
        document.documentElement.style.setProperty('--grid-h', GRID_H);
    </script>
    <style>
        :root {
            --bg-color: #1a2634;
            --panel-bg: #2b2b2b;
            --led-green: #39ff14;
            --led-red: #ff0000;
            --gold: #ffd700;
            --usa-red: #B22234;
            --usa-blue: #3C3B6E;
            --usa-white: #FFFFFF;
            --industrial-steel: #71797E;
            --industrial-orange: #FF6600;
            --paper-white: #e0e0e0;
        }
        body {
            margin: 0;
            overflow: hidden;
            background-color: var(--bg-color);
            color: #eee;
            font-family: 'Courier New', Courier, monospace;
            height: 100vh;
        }

        /* --- App Grid Layout --- */
        #app-grid {
            display: grid;
            grid-template-columns: 490px 1fr 460px;
            height: 100vh;
            overflow: hidden;
        }

        .left-column {
            display: flex;
            flex-direction: row;
            height: 100vh;
            overflow: hidden;
        }

        .center-column {
            overflow: auto;
            /* display: flex;
            justify-content: center;
            align-items: center; */
            background: var(--bg-color);
            box-sizing: border-box;
        }

        .right-column {
            display: flex;
            flex-direction: row;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Mobile Blocker --- */
        #mobile-warning {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 20000;
            flex-direction: column; justify-content: center; align-items: center;
            text-align: center; padding: 40px;
            box-sizing: border-box;
        }
        #mobile-warning > div {
            background: #1a2634;
            border: 4px solid var(--usa-red);
            border-radius: 8px;
            padding: 30px;
            max-width: 450px;
            box-shadow: 0 0 30px var(--usa-red);
        }
        #mobile-warning p { color: #ccc; font-size: 14px; line-height: 1.6; }
        .mobile-warning-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--gold);
            margin-bottom: 15px;
        }
        #mobile-warning p.mobile-warning-footer {
            margin-top: 20px;
            color: #888;
        }

        @media (max-width: 1800px), (max-height: 600px) {
            #mobile-warning { display: flex; }
            #app-grid, .sparks, #modal-overlay { display: none !important; }
        }

        /* --- Fireworks Canvas --- */
        .sparks {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 5;
        }
        #fireworksCanvas {
            width: 100%;
            height: 100%;
        }

        .sparks::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(3px 3px at 100px 50px, var(--industrial-orange), transparent),
                radial-gradient(4px 4px at 200px 150px, #FFD700, transparent),
                radial-gradient(2px 2px at 300px 250px, var(--industrial-orange), transparent),
                radial-gradient(3px 3px at 400px 100px, #FFA500, transparent);
            background-size: 550px 550px;
            animation: sparksAnim 8s linear infinite;
            opacity: 0.4;
            z-index: 1;
        }

        @keyframes sparksAnim {
            100% { transform: translateY(550px); }
        }

        /* --- Layout --- */
        #game-wrapper {
            display: flex;
            padding: 1rem 2rem;
            /* flex-direction: column;
            align-items: center;*/
            justify-content: center;
            /*position: relative;
            max-width: 100%;
            max-height: 100%;*/
        }

        /* Patriotic Border Container */
        #game-frame {
            position: relative;
            border: 12px solid var(--usa-blue);
            border-image: repeating-linear-gradient(45deg, var(--usa-red), var(--usa-red) 10px, var(--usa-white) 10px, var(--usa-white) 20px, var(--usa-blue) 20px, var(--usa-blue) 30px) 20;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
            /* Natural size: 1400x1280 canvas + 24px border = 1424x1304 */
            max-width: 100%;
            max-height: 100%;
            aspect-ratio: 35 / 32;
            width: min(calc(100% - 24px), 1400px);
        }

        @keyframes flagWave {
            0%, 100% {
                transform: translateX(-50%) rotateY(0deg) skewY(0deg);
            }
            25% {
                transform: translateX(-50%) rotateY(-8deg) skewY(2deg);
            }
            75% {
                transform: translateX(-50%) rotateY(8deg) skewY(-2deg);
            }
        }

        #game-frame::before {
            content: '';
            width: 60px;
            height: 40px;
            background-image: url('images/american_flag.svg');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
            transform-style: preserve-3d;
            animation: flagWave 3s ease-in-out infinite;
        }

        /* Year Badges */
        @keyframes colorCycle {
            0%, 22% {
                border-color: var(--usa-red);
                background: var(--usa-blue);
                color: var(--usa-white);
                box-shadow: 0 0 15px var(--usa-red);
            }
            33%, 55% {
                border-color: var(--usa-blue);
                background: var(--usa-white);
                color: var(--usa-blue);
                box-shadow: 0 0 15px var(--usa-blue);
            }
            66%, 89% {
                border-color: var(--usa-red);
                background: var(--usa-white);
                color: var(--usa-blue);
                box-shadow: 0 0 15px var(--usa-red);
            }
            100% {
                border-color: var(--usa-red);
                background: var(--usa-blue);
                color: var(--usa-white);
                box-shadow: 0 0 15px var(--usa-red);
            }
        }

        .year-badge {
            position: absolute;
            top: calc(var(--tile-size) * -0.5px);
            width: calc(var(--tile-size) * 1.5px);
            height: calc(var(--tile-size) * 1.5px);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            border: 3px solid var(--usa-red);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--usa-red);
            z-index: 20;
            font-family: 'Courier New', monospace;
        }
        .year-badge-left {
            left: calc(var(--tile-size) * -1px);
            animation: yearColorSwitchReverse 12s ease-in-out infinite;
        }
        .year-badge-right {
            right: calc(var(--tile-size) * -1px);
            animation: yearColorSwitch 12s ease-in-out infinite;
        }

        .logo-badge {
            position: absolute;
            bottom: calc(var(--tile-size) * -0.5px);
            width: calc(var(--tile-size) * 1.5px);
            height: calc(var(--tile-size) * 1.5px);
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            border: 3px solid var(--usa-blue);
            border-radius: 50%;
            box-shadow: 0 0 15px var(--usa-blue);
            z-index: 20;
            overflow: hidden;
        }
        .logo-badge-left {
            left: calc(var(--tile-size) * -1px);
        }
        .logo-badge-right {
            right: calc(var(--tile-size) * -1px);
        }
        .logo-badge img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }
        .logo-badge img:first-child {
            animation: logoFade 12s ease-in-out infinite;
        }
        .logo-badge img:last-child {
            animation: logoFadeReverse 12s ease-in-out infinite;
        }

        @keyframes logoFade {
            0%, 20% { opacity: 1; }
            30%, 70% { opacity: 0; }
            80%, 100% { opacity: 1; }
        }
        @keyframes logoFadeReverse {
            0%, 20% { opacity: 0; }
            30%, 70% { opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        @keyframes yearColorSwitch {
            0%, 20% {
                background: var(--usa-blue);
                color: var(--usa-white);
            }
            30%, 70% {
                background: var(--usa-white);
                color: var(--usa-blue);
            }
            80%, 100% {
                background: var(--usa-blue);
                color: var(--usa-white);
            }
        }
        @keyframes yearColorSwitchReverse {
            0%, 20% {
                background: var(--usa-white);
                color: var(--usa-blue);
            }
            30%, 70% {
                background: var(--usa-blue);
                color: var(--usa-white);
            }
            80%, 100% {
                background: var(--usa-white);
                color: var(--usa-blue);
            }
        }

        #game-container {
            width: 100%;
            height: 100%;
            cursor: crosshair;
            overflow: hidden;
            background: #1e2430;
            position: relative;
        }
        canvas { display: block; }
        #gameCanvas {
            width: 100%;
            height: 100%;
        }

        /* --- Sidebar --- */
        #stats-sidebar {
            width: 360px;
            background: linear-gradient(180deg, #333 0%, #222 100%);
            border-left: 4px solid #444;
            display: flex;
            flex-direction: column;
            padding: 8px 8px 0;
            z-index: 0;
            overflow-y: auto;
            height: 100vh;
        }

        .panel-header {
            background: repeating-linear-gradient(45deg, var(--usa-red), var(--usa-red) 10px, var(--usa-white) 10px, var(--usa-white) 20px, var(--usa-blue) 20px, var(--usa-blue) 30px);
            padding: 4px; margin-bottom: 10px; text-align: center; border: 2px solid #000; flex-shrink: 0;
        }
        h1 { 
            background: #111; color: var(--gold); margin: 0; padding: 5px; 
            font-size: 14px; text-transform: uppercase; letter-spacing: 1px;
        }

        .stat-card {
            background: #000; border: 2px solid #555; padding: 10px; margin-bottom: 10px;
        }
        .stat-big { font-size: 20px; font-weight: bold; color: var(--led-green); text-shadow: 0 0 4px var(--led-green); }
        .stat-label { font-size: 9px; color: #888; text-transform: uppercase; margin-bottom: 2px; }
        .stat-row { display: flex; justify-content: space-between; align-items: baseline; }

        .graph-section {
            display: flex; flex-direction: column; gap: 10px; margin-bottom: 10px;
        }
        .graph-container {
            background: #051005; border: 2px solid #444; padding: 5px;
            display: flex; flex-direction: column;
        }
        .graph-label {
            font-size: 10px; color: var(--led-green); opacity: 0.8; margin-bottom: 4px;
            font-weight: bold; letter-spacing: 1px;
        }
        
        #tool-info-card {
            background: #1a1a1a;
            border: 2px solid #666;
            border-top: 4px solid #888;
            margin-top: auto;
            margin-bottom: 32px;
            display: flex; flex-direction: column; align-items: center;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        /* Blue Screen Effect */
        .info-screen {
            background: #001133;
            border: 2px inset #444;
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            display: flex; flex-direction: column; align-items: center;
        }
        
        .card-icon { font-size: 32px; margin-bottom: 5px; filter: drop-shadow(0 2px 4px #000); }
        .card-title { color: #fff; font-weight: bold; margin-bottom: 5px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; border-bottom: 1px solid #449; width: 100%; padding-bottom: 4px;}
        .card-desc { font-size: 10px; color: #aaccff; line-height: 1.4; margin-bottom: 8px; text-align: left; width: 100%; }
        
        .status-legend {
            width: 100%; border-top: 1px dashed #449; padding-top: 6px;
            display: flex; justify-content: space-around;
        }
        .legend-item { display: flex; align-items: center; gap: 4px; font-size: 9px; color: #889; }
        .dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }

        /* --- Inspect Mode --- */
        #build-mode {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        #left-toolbar.dimmed {
            opacity: 0.3;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        #inspect-mode {
            display: none; /* Hidden by default */
            flex-direction: column;
            flex: 1;
            min-height: 0;
            overflow-y: auto;
        }

        #inspect-mode-header {
            font-size: 13px;
            font-weight: bold;
            color: var(--gold);
            padding: 15px 0;
            border-bottom: 2px solid #333;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        #inspect-panels {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .inspect-panel {
            background: rgba(26, 38, 52, 0.95);
            border: 2px solid var(--usa-blue);
            border-radius: 6px;
            padding: 10px;
        }

        .inspect-panel-header {
            color: var(--gold);
            font-size: 11px;
            font-weight: bold;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .inspect-panel .stat-row {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            padding: 3px 0;
            border-bottom: 1px dotted #444;
        }

        .inspect-panel .stat-row:last-child {
            border-bottom: none;
        }

        .inspect-panel .stat-label {
            color: #888;
        }

        .inspect-panel .stat-value {
            color: #fff;
            font-weight: bold;
        }

        .buffer-grid {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .buffer-slot {
            width: 24px;
            height: 24px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .buffer-slot.filled {
            border-color: var(--usa-blue);
            background: #0a1a2a;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .filter-btn {
            padding: 8px 4px;
            font-size: 11px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            background: #2a2a2a;
            border: 2px solid #444;
            border-radius: 4px;
            color: #aaa;
            cursor: pointer;
            transition: all 0.15s;
        }

        .filter-btn:hover {
            border-color: #666;
            background: #333;
        }

        .filter-btn.active {
            border-color: var(--usa-blue);
            background: #0a1a3a;
            color: #fff;
        }

        .filter-btn .filter-icon {
            font-size: 16px;
        }

        .direction-grid {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            gap: 8px;
            margin: 10px auto 0;
            width: fit-content;
        }

        .direction-btn {
            padding: 15px;
            font-size: 20px;
            background: rgba(26, 38, 52, 0.95);
            border: 2px solid #444;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
        }

        .direction-btn:hover:not(:disabled) {
            border-color: #666;
            background: #333;
        }

        .direction-btn.active {
            border: 3px solid var(--usa-red);
            background: rgba(220, 53, 69, 0.2);
        }

        .direction-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .rotation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .rotate-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px 8px;
            background: rgba(26, 38, 52, 0.95);
            border: 2px solid var(--usa-blue);
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s;
            font-size: 11px;
        }

        .rotate-button:hover {
            border-color: var(--gold);
            background: #1a2a3a;
        }

        .rotate-button .rotate-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .rotate-button .rotate-label {
            font-weight: bold;
            margin-bottom: 2px;
        }

        .rotate-button .rotate-cost {
            font-size: 10px;
            color: #888;
        }

        .rotate-hint {
            text-align: center;
            font-size: 9px;
            color: #666;
            margin-top: 6px;
        }

        /* Rotation animation */
        @keyframes rotateClockwise {
            from { transform: rotate(0deg); }
            to { transform: rotate(90deg); }
        }

        @keyframes rotateCounterClockwise {
            from { transform: rotate(0deg); }
            to { transform: rotate(-90deg); }
        }

        .rotating-cw {
            animation: rotateClockwise 200ms ease-in-out;
        }

        .rotating-ccw {
            animation: rotateCounterClockwise 200ms ease-in-out;
        }

        .delivery-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 8px;
        }

        .delivery-toggle label {
            color: #aaa;
            font-size: 11px;
        }

        .toggle-switch {
            position: relative;
            width: 40px;
            height: 20px;
            background: #333;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .toggle-switch.on {
            background: var(--usa-blue);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.2s;
        }

        .toggle-switch.on::after {
            left: 22px;
        }

        #exit-inspect-btn {
            margin-top: auto;
            padding: 10px;
        }

        .controls-panel {
            background: #111; border: 1px solid #444; padding: 10px;
            border-radius: 4px; font-size: 11px; color: #aaa;
            margin-top: auto;
            margin-bottom: 32px;
        }
        .control-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
        kbd { background: #333; color: #fff; padding: 1px 4px; border: 1px solid #555; border-radius: 3px; font-weight: bold; font-family: monospace;}

        /* --- Toolbar --- */
        #toolbar-wrapper {
            width: 100%;
            background: #1a1a1a;
            padding: 5px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-top: 4px solid #333;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.5);
            flex-shrink: 0;
        }
        
        #tabs { display: flex; gap: 4px; margin-bottom: -2px; z-index: 5; }
        .tab-btn {
            background: #222; border: 1px solid #444; border-bottom: none;
            color: #888; padding: 4px 12px; font-size: 11px; cursor: pointer;
            border-top-left-radius: 4px; border-top-right-radius: 4px;
            font-weight: bold; transition: all 0.2s; position: relative;
        }
        .tab-btn:hover { background: #333; color: #aaa; }
        .tab-btn.active {
            background: #444; color: var(--gold); border-color: var(--gold); border-bottom: 4px solid #444;
            margin-bottom: -4px; padding-bottom: 8px;
        }
        .lock-icon { font-size: 8px; margin-left: 4px; }

        #toolbar-container {
            background: linear-gradient(to bottom, #444, #2a2a2a);
            border: 2px solid var(--gold); border-radius: 8px;
            padding: 8px 15px; display: flex; gap: 8px; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.8), 0 5px 15px rgba(0,0,0,0.5);
            justify-content: center;
            width: 90%; max-width: 800px;
        }

        .tool-btn {
            flex: 1; /* Take up container */
            height: 70px;
            background: linear-gradient(to bottom, #555, #333);
            border-top: 2px solid #666; border-left: 2px solid #666;
            border-right: 2px solid #222; border-bottom: 2px solid #222;
            border-radius: 6px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; position: relative;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            transition: transform 0.1s;
        }
        .tool-btn:hover { background: linear-gradient(to bottom, #666, #444); }
        .tool-btn:active { transform: translate(1px, 1px); box-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .tool-btn.active { 
            border: 2px solid var(--led-green); background: #222; 
            box-shadow: inset 0 0 10px var(--led-green);
            transform: translate(1px, 1px);
        }
        /* Lock style for mystery items */
        .tool-btn.mystery {
            background: #111; border-color: #333; cursor: not-allowed;
        }
        .tool-btn.mystery .tool-icon { filter: blur(4px) grayscale(1); opacity: 0.3; }
        .tool-btn.mystery .tool-name { color: #555; }
        
        .tool-key { position: absolute; top: 2px; left: 3px; font-size: 9px; color: var(--gold); font-weight: bold; }
        .tool-icon { font-size: 24px; margin-bottom: 2px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .tool-name { font-size: 9px; color: #fff; text-transform: uppercase; margin-bottom: 2px; }
        .tool-cost { font-size: 9px; color: var(--gold); background: #000; padding: 0 3px; border-radius: 2px; }

        /* --- Left Toolbar & Flyout --- */
        #left-toolbar {
            width: 150px;
            background: linear-gradient(180deg, #333 0%, #222 100%);
            border-right: 4px solid #444;
            display: flex;
            flex-direction: column;
            padding: 20px 10px;
            gap: 8px;
            flex-shrink: 0;
            height: 100vh;
        }

        .toolbar-header {
            font-size: 14px;
            font-weight: bold;
            color: var(--gold);
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 2px solid #444;
            margin-bottom: 10px;
        }

        .tool-slot {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .tool-slot:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--usa-blue);
        }

        .tool-slot.selected {
            border-color: var(--industrial-orange);
            background: rgba(255, 102, 0, 0.2);
        }

        .tool-slot .tool-icon {
            font-size: 24px;
            flex-shrink: 0;
        }

        .tool-slot .tool-name {
            flex: 1;
            font-size: 11px;
            font-weight: bold;
            color: #eee;
        }

        .tool-slot .tool-hotkey {
            font-size: 9px;
            color: #888;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Flyout Panel */
        #flyout-panel {
            width: 280px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border-right: 4px solid #333;
            display: flex;
            flex-direction: column;
            padding: 20px 15px;
            flex-shrink: 0;
            position: relative; /* For absolute positioning of inspect-mode */
            transition: opacity 0.1s ease-in-out;
            overflow-y: auto;
            height: 100vh;
        }

        #flyout-panel.fading {
            opacity: 0;
        }

        #flyout-header {
            font-size: 13px;
            font-weight: bold;
            color: var(--gold);
            text-align: center;
            padding-bottom: 12px;
            border-bottom: 2px solid #333;
            margin-bottom: 15px;
        }

        #flyout-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .flyout-variant {
            padding: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 1;
        }

        /* Hide variants not in active slot */
        .flyout-variant.hidden {
            display: none;
        }

        /* Locked variants (not unlocked yet) */
        .flyout-variant.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .flyout-variant.locked:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: transparent;
        }

        /* Selected variant (currently active) */
        .flyout-variant.selected {
            border-color: var(--industrial-orange);
            background: rgba(255, 102, 0, 0.2);
        }

        /* Hover (unlocked only) */
        .flyout-variant:not(.locked):hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--usa-blue);
        }

        .variant-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }

        .variant-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .variant-name {
            flex: 1;
            font-weight: bold;
            color: #eee;
            font-size: 12px;
        }

        .variant-hotkey {
            font-size: 10px;
            color: #888;
            background: rgba(0,0,0,0.3);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .variant-info {
            display: flex;
            gap: 10px;
            margin-bottom: 4px;
            font-size: 10px;
        }

        .variant-cost {
            color: var(--gold);
            font-weight: bold;
        }

        .variant-level {
            color: #888;
        }

        .variant-desc {
            font-size: 10px;
            color: #aaa;
            font-style: italic;
        }

        /* --- Gauge Column --- */
        #gauge-column {
            width: 140px;
            background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
            border-left: 4px solid #333;
            border-right: 4px solid #333;
            display: flex;
            flex-direction: column;
            padding: 8px 10px;
            gap: 10px;
            flex-shrink: 0;
            height: 100vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .gauge-header {
            font-size: 11px;
            font-weight: bold;
            color: var(--gold);
            text-align: center;
            padding-bottom: 8px;
            border-bottom: 2px solid #333;
            margin-bottom: 180px; /* Space to align gauges with graphs */
        }

        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border: 2px solid #444;
            border-radius: 6px;
            padding: 4px;
        }

        .gauge-canvas {
            display: block;
        }

        .gauge-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
            margin-top: 2px;
            letter-spacing: 1px;
        }

        /* --- Modals & Notifications --- */
        /* Old #inspector CSS removed - using unified inspect panel system */

        .notification {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            background: #000; color: var(--led-red); border: 2px solid var(--led-red);
            padding: 8px 20px; font-family: monospace; font-weight: bold;
            opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 50;
        }

        #modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100;
        }
        
        /* Intro Modal */
        .modal-content {
            background: #1a2634; border: 4px solid var(--usa-red); padding: 30px;
            max-width: 450px; text-align: center; color: #fff; border-radius: 8px;
            box-shadow: 0 0 30px var(--usa-red);
        }
        
        /* Victory Report Card Styling */
        #victory-report {
            background: #1a2634;
            color: #eee;
            font-family: 'Courier New', monospace;
            width: 500px;
            padding: 30px;
            border: 4px solid var(--usa-red);
            box-shadow: 0 0 30px var(--usa-red);
            border-radius: 8px;
            text-align: left;
            position: relative;
        }
        #victory-report::before {
            display: none;
        }
        .victory-header {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            font-weight: bold; font-size: 18px; color: var(--gold);
            border-bottom: 2px solid var(--usa-red); padding-bottom: 10px; margin-bottom: 15px;
        }
        .victory-header img {
            width: 30px; height: 20px;
        }
        .report-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .report-divider { border-bottom: 1px solid #555; margin: 10px 0; }
        .grade-stamp {
            position: absolute; top: 40px; right: 30px;
            font-size: 80px; color: #FF3333;
            font-weight: bold; border: 5px solid #FF3333;
            padding: 0 20px; transform: rotate(-15deg); border-radius: 10px;
            text-shadow: 0 0 20px rgba(255, 51, 51, 0.8);
            box-shadow: 0 0 20px rgba(255, 51, 51, 0.5);
        }
        
        .refresh-btn {
            position: absolute; top: 10px; right: 10px;
            background: #ddd; border: 1px solid #999;
            width: 24px; height: 24px; border-radius: 50%;
            cursor: pointer; font-size: 14px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }
        .refresh-btn:hover { background: #ccc; }

        .btn-primary {
            background: var(--usa-blue); color: #fff; border: 2px solid #aaa;
            padding: 10px 20px; font-size: 16px; font-family: monospace; font-weight: bold;
            cursor: pointer; margin-top: 20px; box-shadow: 3px 3px 5px rgba(0,0,0,0.3);
            margin-right: 10px;
        }
        .btn-secondary {
            background: #444; color: #fff; border: 2px solid #aaa;
            padding: 10px 20px; font-size: 16px; font-family: monospace; font-weight: bold;
            cursor: pointer; margin-top: 20px; box-shadow: 3px 3px 5px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>

    <div id="mobile-warning">
        <div>
            <div style="display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold; font-size: 18px; color: var(--gold); border-bottom: 2px solid var(--usa-red); padding-bottom: 10px; margin-bottom: 15px;">
                <img src="images/american_flag.svg" alt="USA" style="width: 30px; height: 20px;">
                USA 250 ‚Ä¢ FACTORY
                <img src="images/american_flag.svg" alt="USA" style="width: 30px; height: 20px;">
            </div>
            <div class="mobile-warning-title">MORE SPACE NEEDED</div>
            <p>Manufacturing operations require more room to operate efficiently.</p>
            <p>Please access this simulation on a desktop or laptop with a larger screen (1800x600px minimum).</p>
            <p class="mobile-warning-footer">A factory floor can't fit in your pocket! üè≠</p>
        </div>
    </div>

    <div class="sparks">
        <canvas id="fireworksCanvas"></canvas>
    </div>

    <div id="app-grid">
    <div class="left-column">
    <!-- Left Toolbar -->
    <div id="left-toolbar">
        <div class="toolbar-header">TOOLS</div>

        <!-- Tool Slots -->
        <div class="tool-slot selected" data-slot="1" data-type="BELT">
            <div class="tool-icon">‚ñ∂</div>
            <div class="tool-name">BELT</div>
            <div class="tool-hotkey">1</div>
        </div>

        <div class="tool-slot" data-slot="2" data-type="ARM">
            <div class="tool-icon">ü¶æ</div>
            <div class="tool-name">ARM</div>
            <div class="tool-hotkey">2</div>
        </div>

        <div class="tool-slot" data-slot="3" data-type="PLASTIC">
            <div class="tool-icon">üî¥</div>
            <div class="tool-name">PLASTIC</div>
            <div class="tool-hotkey">3</div>
        </div>

        <div class="tool-slot" data-slot="4" data-type="STEEL">
            <div class="tool-icon">‚¨ú</div>
            <div class="tool-name">STEEL</div>
            <div class="tool-hotkey">4</div>
        </div>

        <div class="tool-slot" data-slot="5" data-type="CNC">
            <div class="tool-icon">‚öôÔ∏è</div>
            <div class="tool-name">CNC</div>
            <div class="tool-hotkey">5</div>
        </div>

        <div class="tool-slot" data-slot="6" data-type="PRESS">
            <div class="tool-icon">üè≠</div>
            <div class="tool-name">PRESS</div>
            <div class="tool-hotkey">6</div>
        </div>

        <div class="tool-slot" data-slot="7" data-type="SELL">
            <div class="tool-icon">üí≤</div>
            <div class="tool-name">SELL</div>
            <div class="tool-hotkey">7</div>
        </div>
    </div>

    <!-- Flyout Panel (Always Visible, Next to Toolbar) -->
    <div id="flyout-panel">

        <!-- Build Mode: variant selection + tool info -->
        <div id="build-mode">
        <div id="flyout-header">BELT VARIANTS</div>
        <div id="flyout-content">
            <!-- All variants pre-rendered -->
            <!-- BELT Variants (Slot 1) -->
            <div class="flyout-variant" data-slot="1" data-building="BELT">
                <div class="variant-header">
                    <span class="variant-icon">‚ñ∂</span>
                    <span class="variant-name">BELT</span>
                    <span class="variant-hotkey">Alt+1</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$10</span>
                    <span class="variant-level">Level 1</span>
                </div>
                <div class="variant-desc">Standard Conveyor</div>
            </div>

            <div class="flyout-variant" data-slot="1" data-building="BELT_F">
                <div class="variant-header">
                    <span class="variant-icon">‚ñ∂‚ñ∂</span>
                    <span class="variant-name">FAST BELT</span>
                    <span class="variant-hotkey">Alt+2</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$50</span>
                    <span class="variant-level">Level 2</span>
                </div>
                <div class="variant-desc">2x Speed</div>
            </div>

            <!-- ARM Variants (Slot 2) -->
            <div class="flyout-variant hidden" data-slot="2" data-building="ARM">
                <div class="variant-header">
                    <span class="variant-icon">ü¶æ</span>
                    <span class="variant-name">ARM</span>
                    <span class="variant-hotkey">Alt+1</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$30</span>
                    <span class="variant-level">Level 1</span>
                </div>
                <div class="variant-desc">Robot Arm</div>
            </div>

            <div class="flyout-variant hidden" data-slot="2" data-building="ARM_F">
                <div class="variant-header">
                    <span class="variant-icon">üî¨</span>
                    <span class="variant-name">FILTER ARM</span>
                    <span class="variant-hotkey">Alt+2</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$100</span>
                    <span class="variant-level">Level 2</span>
                </div>
                <div class="variant-desc">Item Filtering + 1.5x Speed</div>
            </div>

            <div class="flyout-variant hidden" data-slot="2" data-building="ARM_S">
                <div class="variant-header">
                    <span class="variant-icon">‚ö°</span>
                    <span class="variant-name">SMART ARM</span>
                    <span class="variant-hotkey">Alt+3</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$200</span>
                    <span class="variant-level">Level 3</span>
                </div>
                <div class="variant-desc">Smart Filter + 3x Speed</div>
            </div>

            <div class="flyout-variant hidden" data-slot="2" data-building="ARM_M">
                <div class="variant-header">
                    <span class="variant-icon">ü¶æM</span>
                    <span class="variant-name">MEGA ARM</span>
                    <span class="variant-hotkey">Alt+4</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$2,000</span>
                    <span class="variant-level">Level 4</span>
                </div>
                <div class="variant-desc">Fast + Hyper Reach</div>
            </div>

            <div class="flyout-variant hidden" data-slot="2" data-building="ARM_H">
                <div class="variant-header">
                    <span class="variant-icon">ü¶æH</span>
                    <span class="variant-name">HYPER ARM</span>
                    <span class="variant-hotkey">Alt+5</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$5,000</span>
                    <span class="variant-level">Level 5</span>
                </div>
                <div class="variant-desc">Extended-Reach (2 tiles) ‚Ä¢ 75% speed</div>
            </div>

            <!-- PLASTIC Variants (Slot 3) -->
            <div class="flyout-variant hidden" data-slot="3" data-building="SRC_P">
                <div class="variant-header">
                    <span class="variant-icon">üî¥</span>
                    <span class="variant-name">PLASTIC</span>
                    <span class="variant-hotkey">Alt+1</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$100</span>
                    <span class="variant-level">Level 1</span>
                </div>
                <div class="variant-desc">Plastic Pellet Source</div>
            </div>

            <div class="flyout-variant hidden" data-slot="3" data-building="SRC_P_F">
                <div class="variant-header">
                    <span class="variant-icon">üî¥+</span>
                    <span class="variant-name">HI-FLOW PLASTIC</span>
                    <span class="variant-hotkey">Alt+2</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$250</span>
                    <span class="variant-level">Level 2</span>
                </div>
                <div class="variant-desc">2x Speed</div>
            </div>

            <div class="flyout-variant hidden" data-slot="3" data-building="SRC_P_M">
                <div class="variant-header">
                    <span class="variant-icon">üî¥M</span>
                    <span class="variant-name">MEGA PLASTIC</span>
                    <span class="variant-hotkey">Alt+3</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$500</span>
                    <span class="variant-level">Level 4</span>
                </div>
                <div class="variant-desc">4x Speed</div>
            </div>

            <!-- STEEL Variants (Slot 4) -->
            <div class="flyout-variant hidden" data-slot="4" data-building="SRC_S">
                <div class="variant-header">
                    <span class="variant-icon">‚¨ú</span>
                    <span class="variant-name">STEEL</span>
                    <span class="variant-hotkey">Alt+1</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$150</span>
                    <span class="variant-level">Level 1</span>
                </div>
                <div class="variant-desc">Steel Block Source</div>
            </div>

            <div class="flyout-variant hidden" data-slot="4" data-building="SRC_S_F">
                <div class="variant-header">
                    <span class="variant-icon">‚¨ú+</span>
                    <span class="variant-name">HEAVY STEEL</span>
                    <span class="variant-hotkey">Alt+2</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$350</span>
                    <span class="variant-level">Level 3</span>
                </div>
                <div class="variant-desc">2x Speed</div>
            </div>

            <!-- CNC Variants (Slot 5) -->
            <div class="flyout-variant hidden" data-slot="5" data-building="CNC">
                <div class="variant-header">
                    <span class="variant-icon">‚öôÔ∏è</span>
                    <span class="variant-name">MILL</span>
                    <span class="variant-hotkey">Alt+1</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$500</span>
                    <span class="variant-level">Level 1</span>
                </div>
                <div class="variant-desc">Cuts Steel ‚Üí Mold</div>
            </div>

            <div class="flyout-variant hidden" data-slot="5" data-building="CNC_F">
                <div class="variant-header">
                    <span class="variant-icon">‚öôÔ∏è+</span>
                    <span class="variant-name">TURBO MILL</span>
                    <span class="variant-hotkey">Alt+2</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$1,500</span>
                    <span class="variant-level">Level 3</span>
                </div>
                <div class="variant-desc">2x Speed</div>
            </div>

            <div class="flyout-variant hidden" data-slot="5" data-building="CNC_M">
                <div class="variant-header">
                    <span class="variant-icon">‚öôÔ∏èM</span>
                    <span class="variant-name">MEGA CNC</span>
                    <span class="variant-hotkey">Alt+3</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$3,000</span>
                    <span class="variant-level">Level 4</span>
                </div>
                <div class="variant-desc">Cuts Quad-Mold (4x)</div>
            </div>

            <!-- PRESS Variants (Slot 6) -->
            <div class="flyout-variant hidden" data-slot="6" data-building="PRESS">
                <div class="variant-header">
                    <span class="variant-icon">üè≠</span>
                    <span class="variant-name">PRESS</span>
                    <span class="variant-hotkey">Alt+1</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$800</span>
                    <span class="variant-level">Level 1</span>
                </div>
                <div class="variant-desc">Plastic + Mold ‚Üí Part</div>
            </div>

            <div class="flyout-variant hidden" data-slot="6" data-building="PRESS_M">
                <div class="variant-header">
                    <span class="variant-icon">üè≠M</span>
                    <span class="variant-name">MEGA PRESS</span>
                    <span class="variant-hotkey">Alt+2</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$2,500</span>
                    <span class="variant-level">Level 4</span>
                </div>
                <div class="variant-desc">2x Speed + Quad-Mold</div>
            </div>

            <!-- SELL Variants (Slot 7) -->
            <div class="flyout-variant hidden" data-slot="7" data-building="BIN">
                <div class="variant-header">
                    <span class="variant-icon">üí≤</span>
                    <span class="variant-name">SELL</span>
                    <span class="variant-hotkey">Alt+1</span>
                </div>
                <div class="variant-info">
                    <span class="variant-cost">$100</span>
                    <span class="variant-level">Level 1</span>
                </div>
                <div class="variant-desc">Market Export</div>
            </div>
        </div>

        <!-- Info Card -->
        <div id="tool-info-card">
            <div class="info-screen">
                <div class="card-icon" id="card-icon" style="color: rgb(55, 71, 79);">‚û°</div>
                <div class="card-title" id="card-title">BELT</div>
                <div class="card-desc" id="card-desc">Standard Conveyor. Moves items forward continuously.</div>

                <!-- Status Legend -->
                <div class="status-legend" id="status-legend" style="display:none;">
                    <div class="legend-item"><span class="dot" style="background:#39ff14"></span> OK</div>
                    <div class="legend-item"><span class="dot" style="background:#ffd700"></span> FULL</div>
                    <div class="legend-item"><span class="dot" style="background:#ff0000"></span> ERR</div>
                </div>
            </div>
        </div>
        </div><!-- /#build-mode -->

        <!-- Inspect Mode: building inspection panels -->
        <div id="inspect-mode" style="display: none;">
            <div id="inspect-mode-header">INSPECTING</div>
            <div id="inspect-panels">

                <!-- Status Panel (always visible) -->
                <div id="status-panel" class="inspect-panel">
                    <div class="inspect-panel-header">
                        <span id="status-icon" style="font-size: 18px;"></span>
                        <span id="status-name"></span>
                        <span id="status-indicator" style="margin-left: auto;"></span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Position</span>
                        <span id="status-position" class="stat-value"></span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Cycles</span>
                        <span id="status-cycles" class="stat-value"></span>
                    </div>
                </div>

                <!-- Rotation Panel (show/hide based on building - hidden for sellers) -->
                <div id="rotation-panel" class="inspect-panel" style="display: none;">
                    <div class="inspect-panel-header">ROTATION</div>
                    <div class="rotation-buttons">
                        <button id="rotate-ccw-btn" class="rotate-button">
                            <span class="rotate-icon">‚Ü∫</span>
                            <span class="rotate-label">CCW</span>
                            <span class="rotate-cost" id="rotate-cost-ccw">$0</span>
                        </button>
                        <button id="rotate-cw-btn" class="rotate-button">
                            <span class="rotate-icon">‚Üª</span>
                            <span class="rotate-label">CW</span>
                            <span class="rotate-cost" id="rotate-cost-cw">$0</span>
                        </button>
                    </div>
                    <div class="rotate-hint">90¬∞ counter / clockwise</div>
                </div>

                <!-- Buffer Panel (show/hide based on building) -->
                <div id="buffer-panel" class="inspect-panel" style="display: none;">
                    <div class="inspect-panel-header">INVENTORY</div>

                    <!-- Fixed inventory slots (show/hide based on actual inventory) -->
                    <div class="stat-row inv-slot" id="inv-slot-plastic" style="display: none; padding: 4px 0;">
                        <span class="inv-label">PLASTIC: <span class="inv-count">0</span></span>
                        <button class="insp-btn inv-delete" data-item="plastic" style="padding: 2px 8px; background: #333; border: 1px solid #666; color: #fff; cursor: pointer; border-radius: 3px; font-size: 10px;">DEL</button>
                    </div>
                    <div class="stat-row inv-slot" id="inv-slot-steel" style="display: none; padding: 4px 0;">
                        <span class="inv-label">STEEL: <span class="inv-count">0</span></span>
                        <button class="insp-btn inv-delete" data-item="steel" style="padding: 2px 8px; background: #333; border: 1px solid #666; color: #fff; cursor: pointer; border-radius: 3px; font-size: 10px;">DEL</button>
                    </div>
                    <div class="stat-row inv-slot" id="inv-slot-mold" style="display: none; padding: 4px 0;">
                        <span class="inv-label">MOLD: <span class="inv-count">0</span></span>
                        <button class="insp-btn inv-delete" data-item="mold" style="padding: 2px 8px; background: #333; border: 1px solid #666; color: #fff; cursor: pointer; border-radius: 3px; font-size: 10px;">DEL</button>
                    </div>
                    <div class="stat-row inv-slot" id="inv-slot-mold_quad" style="display: none; padding: 4px 0;">
                        <span class="inv-label">MOLD QUAD: <span class="inv-count">0</span></span>
                        <button class="insp-btn inv-delete" data-item="mold_quad" style="padding: 2px 8px; background: #333; border: 1px solid #666; color: #fff; cursor: pointer; border-radius: 3px; font-size: 10px;">DEL</button>
                    </div>
                    <div class="stat-row inv-slot" id="inv-slot-part" style="display: none; padding: 4px 0;">
                        <span class="inv-label">PART: <span class="inv-count">0</span></span>
                        <button class="insp-btn inv-delete" data-item="part" style="padding: 2px 8px; background: #333; border: 1px solid #666; color: #fff; cursor: pointer; border-radius: 3px; font-size: 10px;">DEL</button>
                    </div>
                    <div class="stat-row inv-slot" id="inv-slot-part_quad" style="display: none; padding: 4px 0;">
                        <span class="inv-label">PART QUAD: <span class="inv-count">0</span></span>
                        <button class="insp-btn inv-delete" data-item="part_quad" style="padding: 2px 8px; background: #333; border: 1px solid #666; color: #fff; cursor: pointer; border-radius: 3px; font-size: 10px;">DEL</button>
                    </div>

                    <!-- Output section (show/hide based on building type) -->
                    <div id="output-section" style="display: none;">
                        <div style="border-top: 1px solid #444; margin: 8px 0;"></div>
                        <div style="font-size: 10px; color: #888; margin-bottom: 4px;">OUTPUT</div>
                        <div class="stat-row" style="padding: 4px 0;">
                            <span id="output-label">NONE (x0)</span>
                            <button class="insp-btn" id="output-delete" style="padding: 2px 8px; background: #333; border: 1px solid #666; color: #fff; cursor: pointer; border-radius: 3px; font-size: 10px;">DEL</button>
                        </div>
                    </div>
                </div>

                <!-- Filter Panel (show/hide based on building) -->
                <div id="filter-panel" class="inspect-panel" style="display: none;">
                    <div class="inspect-panel-header">ITEM FILTER</div>
                    <div class="filter-grid">
                        <button class="filter-btn" data-filter="all" id="filter-btn-all">
                            <span class="filter-icon">‚ö°</span>
                            <span>ALL</span>
                        </button>
                        <button class="filter-btn" data-filter="plastic" id="filter-btn-plastic">
                            <span class="filter-icon">üî¥</span>
                            <span>PLASTIC</span>
                        </button>
                        <button class="filter-btn" data-filter="steel" id="filter-btn-steel">
                            <span class="filter-icon">‚¨ú</span>
                            <span>STEEL</span>
                        </button>
                        <button class="filter-btn" data-filter="mold" id="filter-btn-mold">
                            <span class="filter-icon">üü´</span>
                            <span>MOLD</span>
                        </button>
                        <button class="filter-btn" data-filter="mold_quad" id="filter-btn-mold_quad">
                            <span class="filter-icon">üü´‚Å¥</span>
                            <span>QUAD</span>
                        </button>
                        <button class="filter-btn" data-filter="part" id="filter-btn-part">
                            <span class="filter-icon">‚≠ê</span>
                            <span>PART</span>
                        </button>
                    </div>
                </div>

                <!-- Direction Panel (show/hide based on building) -->
                <div id="direction-panel" class="inspect-panel" style="display: none;">
                    <div class="inspect-panel-header">DELIVERY DIRECTION</div>
                    <div class="direction-grid">
                        <div></div>
                        <button id="dir-btn-up" class="direction-btn" data-dir="3">‚Üë</button>
                        <div></div>
                        <button id="dir-btn-left" class="direction-btn" data-dir="2">‚Üê</button>
                        <div style="display: flex; align-items: center; justify-content: center; color: #555; font-size: 20px;">ü¶æ</div>
                        <button id="dir-btn-right" class="direction-btn" data-dir="0">‚Üí</button>
                        <div></div>
                        <button id="dir-btn-down" class="direction-btn" data-dir="1">‚Üì</button>
                        <div></div>
                    </div>
                </div>

            </div>
            <button id="exit-inspect-btn" class="btn-secondary" style="width: 100%; margin-top: 10px;">
                RETURN TO BUILD MODE
            </button>
        </div>

    </div>
    </div><!-- /.left-column -->

    <div class="center-column">
    <div id="game-wrapper">
        <div id="game-frame">
            <div class="year-badge year-badge-left">1776</div>
            <div class="year-badge year-badge-right">2026</div>
            <a href="https://www.kaizen.io/" target="_blank" class="logo-badge logo-badge-left" style="cursor: pointer; text-decoration: none;">
                <img src="images/favicon.svg" alt="Kaizen">
                <img src="images/favicon-reverse.svg" alt="Kaizen Reverse">
            </a>
            <a href="https://www.kaizen.io/" target="_blank" class="logo-badge logo-badge-right" style="cursor: pointer; text-decoration: none;">
                <img src="images/favicon-reverse.svg" alt="Kaizen Reverse">
                <img src="images/favicon.svg" alt="Kaizen">
            </a>
            <div id="game-container">
                <canvas id="gameCanvas"></canvas>
                <div id="notification" class="notification">ALERT</div>
                
                <!-- Old inspector removed - using unified inspect panel system -->
            </div>
        </div>
    </div>
    </div><!-- /.center-column -->

    <div class="right-column">
    <div id="gauge-column">
        <div class="gauge-header">PRODUCTION</div>
        <div class="gauge-container" id="gauge-plastic">
            <canvas class="gauge-canvas" width="100" height="100"></canvas>
            <div class="gauge-label">PLASTIC</div>
        </div>
        <div class="gauge-container" id="gauge-steel">
            <canvas class="gauge-canvas" width="100" height="100"></canvas>
            <div class="gauge-label">STEEL</div>
        </div>
        <div class="gauge-container" id="gauge-mold">
            <canvas class="gauge-canvas" width="100" height="100"></canvas>
            <div class="gauge-label">MOLDS</div>
        </div>
        <div class="gauge-container" id="gauge-part">
            <canvas class="gauge-canvas" width="100" height="100"></canvas>
            <div class="gauge-label">PARTS</div>
        </div>
        <div class="gauge-container" id="gauge-revenue">
            <canvas class="gauge-canvas" width="100" height="100"></canvas>
            <div class="gauge-label">$/MIN</div>
        </div>
    </div>

    <div id="stats-sidebar">
        <div class="panel-header">
            <h1>USA MANUFACTURING 1776 - 2026</h1>
        </div>
        
        <div class="stat-card">
            <div class="stat-row">
                <div>
                    <div class="stat-label">REVENUE</div>
                    <div class="stat-big" style="color:var(--gold)" id="moneyDisplay">$600</div>
                </div>
                <div style="text-align:right">
                    <div class="stat-label">TIER</div>
                    <div class="stat-big" id="levelDisplay">1</div>
                </div>
            </div>
            <div style="margin-top:10px; font-size:10px; color:#0f0; border-top:1px dashed #333; padding-top:5px;">
                &gt; NEXT: <span id="nextUnlockDisplay" style="color:#fff">50 PARTS</span>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-row">
                <span class="stat-label">TIME</span>
                <span style="font-family:monospace; font-weight:bold; color:var(--led-red);" id="timeDisplay">00:00</span>
            </div>
            <div class="stat-row">
                <span class="stat-label">GOAL</span>
                <span style="color:var(--led-green); font-weight:bold">$1M</span>
            </div>
        </div>

        <div class="graph-section">
            <div class="graph-container">
                <div class="graph-label">PLASTIC RATE</div>
                <canvas id="graphPlastic" width="240" height="80"></canvas>
            </div>
            <div class="graph-container">
                <div class="graph-label">STEEL RATE</div>
                <canvas id="graphSteel" width="240" height="80"></canvas>
            </div>
            <div class="graph-container">
                <div class="graph-label">TOOLING RATE (Molds)</div>
                <canvas id="graphTooling" width="240" height="80"></canvas>
            </div>
            <div class="graph-container">
                <div class="graph-label">PARTS RATE</div>
                <canvas id="graphParts" width="240" height="80"></canvas>
            </div>
            <div class="graph-container">
                <div class="graph-label">REVENUE RATE ($/min)</div>
                <canvas id="graphRevenue" width="240" height="80"></canvas>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls-panel">
            <div style="margin-bottom:6px; font-weight:bold; color:#fff; border-bottom:1px solid #444; padding-bottom:2px;">OPERATOR CONTROLS</div>
            <div class="control-row"><span>SELECT TOOL</span> <kbd>1-7</kbd></div>
            <div class="control-row"><span>SELECT VARIANT</span> <kbd>Alt+1-4</kbd></div>
            <div class="control-row"><span>CYCLE VARIANT</span> <kbd>Shift+1-7</kbd></div>
            <div class="control-row"><span>ROTATE</span> <kbd>R</kbd></div>
            <div class="control-row"><span>BUILD/CFG</span> <kbd>L-Click</kbd></div>
            <div class="control-row"><span>SCRAP</span> <kbd>R-Click</kbd></div>
            <div class="control-row"><span>MANUAL</span> <kbd>I</kbd></div>
        </div>
    </div>

    <div id="modal-overlay">
        <!-- Attribution Footer -->
        <div id="attribution-footer" style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); text-align: center; color: #ccc; font-size: 14px; z-index: 101; background: #1a2634; padding: 12px 30px; border-radius: 8px; border: 4px solid var(--usa-red); box-shadow: 0 0 30px var(--usa-red);">
            <div style="color: var(--gold); font-weight: bold; margin-bottom: 5px; font-size: 13px;">USA 250th Anniversary Edition</div>
            Original concept by <a href="https://x.com/aphysicist" target="_blank" style="color: #4A9EFF; text-decoration: none;">Aaron Slodov</a>
            and <a href="https://x.com/atomic_inc" target="_blank" style="color: #4A9EFF; text-decoration: none;">Atomic Industries</a>
            ‚Ä¢ <a href="https://gemini.google.com/share/01013b32007e" target="_blank" style="color: #4A9EFF; text-decoration: none;">Play original ‚Üí</a>
            <br>
            American Reindustrialization by Hondo, Hawk and Kijana Woodard of <a href="https://www.kaizen.io/" target="_blank" style="color: #4A9EFF; text-decoration: none;">kaizen.io</a>
            ‚Ä¢ Christmas Break 2025
            ‚Ä¢ <a href="changes/index.html" target="_blank" style="color: var(--industrial-orange); text-decoration: none;">üìã Changelog</a>
        </div>

        <!-- Intro -->
        <div id="intro-modal" class="modal-content">
            <h2 style="color: var(--gold); margin-top:0;">MANUFACTURING SIM ‚Ä¢ USA 250</h2>
            <p style="color: #ccc; font-size: 12px; margin-bottom: 5px;">1776 - 2026</p>
            <p style="color: #aaa; font-size: 11px; margin-bottom: 20px; font-style: italic;">Celebrating 250 Years of American Innovation</p>
            <p><strong>MISSION: MANUFACTURE AMERICAN MADE PARTS</strong></p>
            <ul style="text-align: left; margin: 20px 0; font-size: 13px; line-height: 1.6; list-style: none; padding-left: 10px;">
                <li>üî¥ <strong>Plastic</strong> + üßä <strong>Mold</strong> = ‚≠ê <strong>Part</strong></li>
                <li>‚öôÔ∏è <strong>Machines</strong> do NOT auto-load.</li>
                <li>ü¶æ <strong>Arms</strong> are required to move items.</li>
                <li>üñ±Ô∏è <strong>Click Machines</strong> to manage inventory.</li>
                <li>‚å®Ô∏è <strong>Press I</strong> anytime for help.</li>
                <li>üìä <strong>Press V</strong> to view victory report.</li>
            </ul>
            <div id="intro-buttons" style="display: flex; gap: 10px; justify-content: center;">
                <button id="btn-start" class="btn-primary" onclick="startGame()">START PRODUCTION</button>
                <button id="btn-continue" class="btn-primary" onclick="continueGame()" style="display: none;">CONTINUE</button>
                <button id="btn-reset" class="btn-secondary" onclick="resetGame()" style="display: none;">NEW FACILITY</button>
            </div>
        </div>

        <!-- Victory Report -->
        <div id="win-modal" style="display:none; justify-content:center; align-items:center; height:100%;">
            <div id="victory-report">
                <div class="victory-header">
                    <img src="images/american_flag.svg" alt="USA">
                    USA 250 ‚Ä¢ FACTORY
                    <img src="images/american_flag.svg" alt="USA">
                </div>
                <button class="refresh-btn" onclick="populateVictoryReport()">‚Üª</button>
                <div class="grade-stamp" id="gradeStamp">A</div>
                <div class="report-row">
                    <span>DATE:</span> <span id="reportDate">DEC 25 2025</span>
                </div>
                <div class="report-row">
                    <span>FOREMAN:</span> <span>YOU</span>
                </div>
                
                <div class="report-divider"></div>
                
                <div style="font-weight:bold; margin-bottom:10px;">PRODUCTION METRICS</div>
                <div class="report-row">
                    <span>TOTAL REVENUE:</span> <span id="repRevenue">$0</span>
                </div>
                <div class="report-row">
                    <span>TIME ELAPSED:</span> <span id="repTime">00:00</span>
                </div>
                <div class="report-row">
                    <span>PEAK EFFICIENCY:</span> <span id="repPeak">0 PPM</span>
                </div>
                
                <div class="report-divider"></div>
                
                <div style="font-weight:bold; margin-bottom:10px;">MATERIAL CONSUMPTION</div>
                <div class="report-row">
                    <span>PLASTIC PELLETS:</span> <span id="repPlastic">0</span>
                </div>
                <div class="report-row">
                    <span>STEEL BLOCKS:</span> <span id="repSteel">0</span>
                </div>
                <div class="report-row">
                    <span>MOLDS CUT:</span> <span id="repMolds">0</span>
                </div>
                <div class="report-row">
                    <span>PARTS SHIPPED:</span> <span id="repParts">0</span>
                </div>

                <div class="report-divider"></div>
                <div style="text-align:center; font-size:11px; margin-top:15px; color:#aaa;">
                    <a href="https://www.kaizen.io>" style="color: #4A9EFF; text-decoration: none;">kaizen.io</a><br>
                    MADE IN USA <img src="images/american_flag.svg" alt="USA" style="width:12px; vertical-align:middle;">
                    2026 ¬© All Rights Reserved.
                </div>
                
                <div style="text-align:center;">
                    <button class="btn-primary" onclick="continueGame()">CONTINUE OPERATIONS</button>
                    <button class="btn-secondary" onclick="resetGame()">NEW FACILITY</button>
                </div>
            </div>
        </div>

    </div>
    </div><!-- /.right-column -->
    </div><!-- /#app-grid -->

    <!-- Old ARM Configuration Modal removed - using unified inspect panel system -->

    <!-- Debug Panel for Local Development -->
    <div id="debug-panel" style="display:none; position:fixed; top:20px; right:20px; background:#1a2634; padding:20px; border-radius:8px; border:3px solid var(--gold); box-shadow:0 0 20px rgba(255,215,0,0.3); z-index:10000; min-width:280px; font-family:'Courier New', monospace;">
        <h3 style="color:var(--gold); margin:0 0 15px 0; text-align:center; font-size:16px;">üîß DEBUG MODE</h3>
        <div style="color:#aaa; font-size:11px; margin-bottom:15px; text-align:center;">Press ` (backtick) to toggle</div>

        <div style="margin-bottom:15px;">
            <label style="color:#ccc; display:block; margin-bottom:5px; font-size:12px;">üí∞ Current Money:</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="debug-money" style="flex:1; background:#2b2b2b; border:1px solid #555; color:#fff; padding:5px; border-radius:4px; font-family:'Courier New', monospace;" value="0">
                <button onclick="applyDebugMoney()" style="background:var(--usa-red); border:none; color:#fff; padding:5px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">SET</button>
            </div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="color:#ccc; display:block; margin-bottom:5px; font-size:12px;">‚≠ê Parts Created:</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="debug-parts" style="flex:1; background:#2b2b2b; border:1px solid #555; color:#fff; padding:5px; border-radius:4px; font-family:'Courier New', monospace;" value="0">
                <button onclick="applyDebugParts()" style="background:var(--usa-red); border:none; color:#fff; padding:5px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">SET</button>
            </div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="color:#ccc; display:block; margin-bottom:5px; font-size:12px;">üìä Lifetime Revenue:</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="debug-revenue" style="flex:1; background:#2b2b2b; border:1px solid #555; color:#fff; padding:5px; border-radius:4px; font-family:'Courier New', monospace;" value="0">
                <button onclick="applyDebugRevenue()" style="background:var(--usa-red); border:none; color:#fff; padding:5px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">SET</button>
            </div>
        </div>

        <div style="margin-bottom:15px;">
            <label style="color:#ccc; display:block; margin-bottom:5px; font-size:12px;">üéöÔ∏è Level (1-5):</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="debug-level" min="1" max="5" style="flex:1; background:#2b2b2b; border:1px solid #555; color:#fff; padding:5px; border-radius:4px; font-family:'Courier New', monospace;" value="1">
                <button onclick="applyDebugLevel()" style="background:var(--usa-red); border:none; color:#fff; padding:5px 15px; border-radius:4px; cursor:pointer; font-weight:bold;">SET</button>
            </div>
        </div>

        <div style="border-top:1px solid #555; padding-top:15px; margin-top:15px;">
            <button onclick="syncDebugValues()" style="width:100%; background:var(--usa-blue); border:none; color:#fff; padding:8px; border-radius:4px; cursor:pointer; font-weight:bold; margin-bottom:8px;">‚Üª SYNC FROM GAME</button>
            <button onclick="toggleDebugPanel()" style="width:100%; background:#555; border:none; color:#fff; padding:8px; border-radius:4px; cursor:pointer;">CLOSE</button>
        </div>
    </div>

    <script>
        // Grid dimensions are defined in head script
        const TILE_SIZE = window.TILE_SIZE;
        const GRID_W = window.GRID_W;
        const GRID_H = window.GRID_H;
        const TICK_RATE = 1000 / 60;

        const C_PLASTIC = '#d32f2f';
        const C_STEEL = '#cfd8dc';
        const C_MOLD = '#81d4fa';
        const C_PART = '#ffd700'; 
        
        const ITEM = { PLASTIC: 'plastic', STEEL: 'steel', MOLD: 'mold', PART: 'part', MOLD_QUAD: 'mold_quad' };

        const LEVELS = {
            1: { reqParts: 0 },
            2: { reqParts: 50 },
            3: { reqParts: 250 },
            4: { reqParts: 1000 },
            5: { reqParts: 5000 },
        };
        const MAX_LEVEL = 5;

        // Define all building variants
        const ALL_BUILDINGS = {
            // BELT variants
            BELT: { id: 'belt', name: 'BELT', cost: 10, color: '#90a4ae', icon: '‚ñ∂', reqLevel: 1, transportSpeed: 0.05, desc: "Standard Conveyor. Moves items forward continuously." },
            BELT_F: { id: 'belt_fast', name: 'FAST BELT', cost: 50, color: '#d32f2f', icon: '‚ñ∂‚ñ∂', reqLevel: 2, transportSpeed: 0.10, desc: "High Speed Conveyor. Moves items 2x faster than standard belts." },

            // ARM variants
            ARM: { id: 'arm_basic', name: 'ARM', cost: 30, color: '#fbc02d', icon: 'ü¶æ', reqLevel: 1, isArm: true, speed: 1.0, desc: "Robot Arm. Moves items from BELTS to MACHINES. Essential for automation." },
            ARM_F: { id: 'arm_filter', name: 'FILTER ARM', cost: 100, color: '#8e24aa', icon: 'üî¨', reqLevel: 2, isArm: true, speed: 1.5, canFilter: true, desc: "Smart Filter Arm. Click placed arm to select item type. Ignores other items." },
            ARM_S: { id: 'arm_smart', name: 'SMART ARM', cost: 200, color: '#006064', icon: '‚ö°', reqLevel: 3, isArm: true, speed: 3.0, canFilter: true, desc: "High-Speed Servo Arm. Transfers items 3x faster." },
            ARM_M: { id: 'arm_mega', name: 'MEGA ARM', cost: 1000, color: '#64b5f6', icon: 'ü¶æM', reqLevel: 4, isArm: true, speed: 3.0, canFilter: true, canDirectDeliver: true, desc: "Omni-Directional Mega Arm. Click to set delivery direction (Up/Down/Left/Right). 3x speed." },
            ARM_H: { id: 'arm_hyper', name: 'HYPER ARM', cost: 5000, color: '#00D4FF', icon: 'ü¶æH', reqLevel: 5, isArm: true, speed: 0.75, canFilter: true, canDirectDeliver: false, reachDistance: 2, desc: "Extended-Reach Robotic Arm. Picks up from 2 squares behind, delivers 2 squares forward. 75% speed due to longer travel distance." },

            // PLASTIC SOURCE variants
            SRC_P: { id: 'src_p', name: 'PLASTIC', cost: 100, color: '#c62828', icon: 'üî¥', reqLevel: 1, output: ITEM.PLASTIC, speed: 60, desc: "Infinite source of Red Plastic Pellets. Used in Injection Presses." },
            SRC_P_F: { id: 'src_p_fast', name: 'HI-FLOW PLASTIC', cost: 250, color: '#d32f2f', icon: 'üî¥+', reqLevel: 2, output: ITEM.PLASTIC, speed: 30, desc: "High-Volume Plastic Hopper. Outputs 2x faster." },
            SRC_P_M: { id: 'src_p_mega', name: 'MEGA PLASTIC', cost: 500, color: '#b71c1c', icon: 'üî¥M', reqLevel: 4, output: ITEM.PLASTIC, speed: 15, desc: "Ultra High-Speed Plastic Extruder. Outputs 4x faster than standard." },

            // STEEL SOURCE variants
            SRC_S: { id: 'src_s', name: 'STEEL', cost: 150, color: '#78909c', icon: '‚¨ú', reqLevel: 1, output: ITEM.STEEL, speed: 120, desc: "Infinite source of Steel Blocks. Used to cut Molds." },
            SRC_S_F: { id: 'src_s_fast', name: 'HEAVY STEEL', cost: 350, color: '#546e7a', icon: '‚¨ú+', reqLevel: 3, output: ITEM.STEEL, speed: 60, desc: "Heavy Duty Steel Stock. Outputs 2x faster." },

            // MILL variants
            CNC: { id: 'cnc', name: 'MILL', cost: 500, color: '#0277bd', icon: '‚öôÔ∏è', reqLevel: 1, recipe: { in: ITEM.STEEL, out: ITEM.MOLD, time: 180 }, desc: "Subtractive Manufacturing. Cuts 1 Steel into 1 Mold." },
            CNC_F: { id: 'cnc_fast', name: 'TURBO MILL', cost: 1500, color: '#1565c0', icon: '‚öôÔ∏è+', reqLevel: 3, recipe: { in: ITEM.STEEL, out: ITEM.MOLD, time: 90 }, desc: "High-RPM CNC Mill. Cuts molds 2x faster." },
            CNC_M: { id: 'cnc_mega', name: 'MEGA CNC', cost: 3000, color: '#004d40', icon: '‚öôÔ∏èM', reqLevel: 4, recipe: { in: ITEM.STEEL, out: ITEM.MOLD_QUAD, time: 180 }, desc: "5-Axis Mega Mill. Cuts Steel into Quad-Cavity Molds (4x Output potential)." },

            // PRESS variants
            PRESS: { id: 'press', name: 'PRESS', cost: 800, color: '#ef6c00', icon: 'üè≠', reqLevel: 1, recipe: { in: ITEM.PLASTIC, out: ITEM.PART, time: 60 }, maxLife: 10, desc: "Injection Molding Machine. Requires 1 Plastic + 1 Mold. Molds degrade after 10 cycles." },
            PRESS_M: { id: 'press_mega', name: 'MEGA PRESS', cost: 2500, color: '#e65100', icon: 'üè≠M', reqLevel: 4, recipe: { in: ITEM.PLASTIC, out: ITEM.PART, time: 30 }, maxLife: 10, desc: "Industrial Press. 2x Speed. Supports Quad-Molds (4x output). Molds degrade after 10 cycles." },

            // SELL
            BIN: { id: 'bin', name: 'SELL', cost: 100, color: '#2e7d32', icon: 'üí≤', reqLevel: 1, desc: "Market Export. Sells items. PRICES: Part=$45, Mold=$20, Raw=$1." },
        };

        // Define tool slots - each slot represents a building type with its variants
        const TOOL_SLOTS = [
            { slot: 1, type: 'BELT', name: 'BELT', icon: '‚ñ∂', variants: ['BELT', 'BELT_F'] },
            { slot: 2, type: 'ARM', name: 'ARM', icon: 'ü¶æ', variants: ['ARM', 'ARM_F', 'ARM_S', 'ARM_M', 'ARM_H'] },
            { slot: 3, type: 'PLASTIC', name: 'PLASTIC', icon: 'üî¥', variants: ['SRC_P', 'SRC_P_F', 'SRC_P_M'] },
            { slot: 4, type: 'STEEL', name: 'STEEL', icon: '‚¨ú', variants: ['SRC_S', 'SRC_S_F'] },
            { slot: 5, type: 'CNC', name: 'CNC', icon: '‚öôÔ∏è', variants: ['CNC', 'CNC_F', 'CNC_M'] },
            { slot: 6, type: 'PRESS', name: 'PRESS', icon: 'üè≠', variants: ['PRESS', 'PRESS_M'] },
            { slot: 7, type: 'SELL', name: 'SELL', icon: 'üí≤', variants: ['BIN'] },
        ];

        // Alias for clarity in new toolbar code
        const BUILDING_SLOTS = TOOL_SLOTS;

        // Legacy BUILDINGS object for backward compatibility
        const BUILDINGS = ALL_BUILDINGS;

        const SELL_PRICES = { [ITEM.PART]: 45, [ITEM.MOLD]: 20, [ITEM.STEEL]: 1, [ITEM.PLASTIC]: 1, [ITEM.MOLD_QUAD]: 100 };

        let canvas, ctx, gPlasticCanvas, gPlasticCtx, gSteelCanvas, gSteelCtx, gToolCanvas, gToolCtx, gPartsCanvas, gPartsCtx, gRevCanvas, gRevCtx;
        let gaugeCtxs = {};
        let gaugePeaks = { plastic: 10, steel: 10, mold: 10, part: 10, dollars: 100 };
        let gaugeEMA = { plastic: 0, steel: 0, mold: 0, part: 0, dollars: 0 };
        let gaugeDisplayed = { plastic: 0, steel: 0, mold: 0, part: 0, dollars: 0 };
        let gaugePrevEMA = { plastic: 0, steel: 0, mold: 0, part: 0, dollars: 0 };
        let gaugeTrendCount = { plastic: 0, steel: 0, mold: 0, part: 0, dollars: 0 };  // +N = trending up, -N = trending down
        let smoothedHistory = [];  // Stores smoothed rates for graphs
        let money = 600;
        let lifetimeRevenue = 600;
        let partsSoldTotal = 0;
        let totalPlasticUsed = 0;
        let totalSteelUsed = 0;
        let totalMoldsMade = 0;
        let level = 1;
        let currentTab = 1;
        let gameRunning = false;
        let hasWon = false;
        let startTime = 0;
        let selectedTool = 'belt';
        let selectedSlot = 1; // Track which slot number is selected (1-7)

        // Track currently selected variant for each slot
        let selectedVariants = {
            1: 'BELT',      // Slot 1: Basic belt
            2: 'ARM',       // Slot 2: Basic arm
            3: 'SRC_P',     // Slot 3: Basic plastic source
            4: 'SRC_S',     // Slot 4: Basic steel source
            5: 'CNC',       // Slot 5: Basic CNC
            6: 'PRESS',     // Slot 6: Basic press
            7: 'BIN'        // Slot 7: Sell bin
        };

        let rotation = 0;
        let isDragging = false;
        let mouseGridPos = { x: -1, y: -1 };
        
        let grid = [];
        let buildings = [];
        let items = [];
        let inspectedBuilding = null;
        let isInspectMode = false;
        let lastInspectorStructure = '';
        let metrics = { history: [], current: { plastic: 0, steel: 0, mold: 0, part: 0, dollars: 0 } };

        class Tile { constructor(x, y) { this.x = x; this.y = y; this.building = null; } }

        class Building {
            constructor(type, x, y, rot) {
                this.type = type;
                this.x = x; this.y = y; this.rot = rot;
                this.timer = 0;
                this.inventory = { [ITEM.PLASTIC]: 0, [ITEM.STEEL]: 0, [ITEM.MOLD]: 0, [ITEM.MOLD_QUAD]: 0 };
                this.outputBuffer = null;
                this.outputCount = 0;
                this.moldLife = 0;
                this.maxMoldLife = type.maxLife || 0;
                this.heldItem = null;
                this.armAnim = 0;
                this.filter = null;
                this.lastSoldTime = 0;
                this.deliverDir = rot; // For MEGA ARM - delivery direction (default: forward)
            }
            cycleFilter() {
                if (!this.type.canFilter) return;
                const types = [null, ITEM.PLASTIC, ITEM.STEEL, ITEM.MOLD, ITEM.MOLD_QUAD, ITEM.PART];
                let idx = types.indexOf(this.filter);
                this.filter = types[(idx + 1) % types.length];
            }
            update() {
                if (this.type.isArm) this.updateArm();
                else this.updateMachine();
            }
            updateArm() {
                let speed = this.type.speed * 0.05;
                // Use deliverDir for delivery target (MEGA ARM can deliver in any cardinal direction)
                let deliveryDirection = this.type.canDirectDeliver ? this.deliverDir : this.rot;
                // Use reachDistance for HYPER ARM (2 tiles) or default to 1 for regular ARMs
                const reachDistance = this.type.reachDistance || 1;

                if (this.heldItem) {
                    if (this.armAnim < 1.0) this.armAnim = Math.min(1.0, this.armAnim + speed);
                    else {
                        let targetXY = getNeighborAtDistance(this.x, this.y, deliveryDirection, reachDistance);
                        if (this.attemptDrop(targetXY, this.heldItem)) this.heldItem = null;
                    }
                } else {
                    if (this.armAnim > 0) this.armAnim = Math.max(0, this.armAnim - speed);
                    else {
                        let sourceXY = getNeighborAtDistance(this.x, this.y, (this.rot + 2) % 4, reachDistance);
                        let targetXY = getNeighborAtDistance(this.x, this.y, deliveryDirection, reachDistance);
                        let item = this.attemptPickup(sourceXY, targetXY);
                        if (item) this.heldItem = item;
                    }
                }
            }
            updateMachine() {
                if (this.type.output) {
                    this.timer++;
                    if (this.timer >= this.type.speed) {
                        if (!this.outputBuffer) {
                            this.outputBuffer = this.type.output;
                            this.outputCount = 1;
                            if (this.type.output === ITEM.PLASTIC) { metrics.current.plastic++; }
                            if (this.type.output === ITEM.STEEL) { metrics.current.steel++; }
                            this.timer = 0;
                        }
                    }
                }
                
                if (this.type.id.includes('cnc')) {
                    if (!this.outputBuffer && this.inventory[ITEM.STEEL] > 0) {
                        this.timer++;
                        if (this.timer >= this.type.recipe.time) {
                            this.inventory[ITEM.STEEL]--;
                            totalSteelUsed++; // Track Consumption
                            if (this.type.id === 'cnc_mega') {
                                this.outputBuffer = ITEM.MOLD_QUAD;
                            } else {
                                this.outputBuffer = ITEM.MOLD;
                            }
                            metrics.current.mold++;
                            totalMoldsMade++;
                            this.outputCount = 1;
                            this.timer = 0;
                        }
                    } else if (this.inventory[ITEM.STEEL] === 0) this.timer = 0;
                }

                if (this.type.id.includes('press')) {
                    if (this.moldLife <= 0) {
                        if (this.inventory[ITEM.MOLD_QUAD] > 0 && this.type.id === 'press_mega') {
                            this.inventory[ITEM.MOLD_QUAD]--;
                            this.moldLife = this.maxMoldLife;
                            this.currentMoldType = ITEM.MOLD_QUAD;
                        } else if (this.inventory[ITEM.MOLD] > 0) {
                            this.inventory[ITEM.MOLD]--;
                            this.moldLife = this.maxMoldLife;
                            this.currentMoldType = ITEM.MOLD;
                        }
                    }

                    if (this.moldLife > 0 && (!this.outputBuffer || (this.outputBuffer === ITEM.PART && this.outputCount < 5))) {
                        let plasticNeeded = (this.currentMoldType === ITEM.MOLD_QUAD) ? 4 : 1;
                        if (this.inventory[ITEM.PLASTIC] >= plasticNeeded) {
                            this.timer++;
                            if (this.timer >= this.type.recipe.time) {
                                this.inventory[ITEM.PLASTIC] -= plasticNeeded;
                                totalPlasticUsed += plasticNeeded; // Track Consumption
                                this.outputBuffer = ITEM.PART;
                                let produced = (this.currentMoldType === ITEM.MOLD_QUAD) ? 4 : 1;
                                this.outputCount += produced;
                                metrics.current.part += produced;
                                this.moldLife--;
                                this.timer = 0;
                            }
                        } else this.timer = 0;
                    } else if (this.moldLife <= 0) this.timer = 0;
                }

                if (this.outputBuffer && this.type.id.includes('src')) {
                    let targetXY = getNeighbor(this.x, this.y, this.rot);
                    if (isValid(targetXY)) {
                        let targetTile = grid[targetXY.y][targetXY.x];
                        if (targetTile.building && targetTile.building.type.transportSpeed) {
                            if (isSpaceFree(targetXY.x, targetXY.y)) {
                                let it = new Item(this.outputBuffer, targetXY.x, targetXY.y);
                                it.sourceDir = (this.rot + 2) % 4; // Crucial for smoothing
                                items.push(it);
                                this.outputCount--;
                                if (this.outputCount <= 0) {
                                    this.outputBuffer = null;
                                    this.outputCount = 0;
                                }
                            }
                        }
                    }
                }
            }
            attemptPickup(pos, targetPos) {
                if (!isValid(pos)) return null;
                let tile = grid[pos.y][pos.x];
                if (!tile.building) return null;
                
                let canAcceptFunc = (itemType) => {
                    if (!isValid(targetPos)) return true;
                    let tTile = grid[targetPos.y][targetPos.x];
                    if (!tTile.building) return true;
                    let b = tTile.building;
                    if (b.type.id.includes('cnc')) {
                        if (itemType === ITEM.STEEL && b.inventory[ITEM.STEEL] >= 5) return false;
                        if (itemType !== ITEM.STEEL) return false;
                    } else if (b.type.id.includes('press')) {
                        if (itemType === ITEM.PLASTIC && b.inventory[ITEM.PLASTIC] >= 20) return false;
                        if (itemType === ITEM.MOLD && b.inventory[ITEM.MOLD] >= 5) return false;
                        if (itemType === ITEM.MOLD_QUAD && b.inventory[ITEM.MOLD_QUAD] >= 5) return false;
                        // Only MEGA PRESS can accept MOLD_QUAD
                        const acceptableItems = b.type.id === 'press_mega'
                            ? [ITEM.PLASTIC, ITEM.MOLD, ITEM.MOLD_QUAD]
                            : [ITEM.PLASTIC, ITEM.MOLD];
                        if (!acceptableItems.includes(itemType)) return false;
                    }
                    return true;
                };

                if (tile.building.outputBuffer && tile.building.outputCount > 0) {
                    let it = tile.building.outputBuffer;
                    if (this.filter && it !== this.filter) return null;
                    if (!canAcceptFunc(it)) return null;
                    
                    tile.building.outputCount--;
                    if (tile.building.outputCount <= 0) tile.building.outputBuffer = null;
                    return it;
                }
                
                if (tile.building.type.transportSpeed) {
                    let bestItem = null, bestProgress = -1;
                    for (let i = 0; i < items.length; i++) {
                        let it = items[i];
                        if (Math.floor(it.x) === pos.x && Math.floor(it.y) === pos.y) {
                            if (this.filter && it.type !== this.filter) continue;
                            if (!canAcceptFunc(it.type)) continue;
                            // Pick item with highest progress (furthest along = FIFO order)
                            if (it.progress > bestProgress) { bestProgress = it.progress; bestItem = it; }
                        }
                    }
                    if (bestItem) { bestItem.markedForDeletion = true; return bestItem.type; }
                }
                return null;
            }
            attemptDrop(pos, itemType) {
                if (!isValid(pos)) return false;
                let tile = grid[pos.y][pos.x];
                if (!tile.building) return false;
                let b = tile.building;
                
                if (b.type.id === 'bin') { 
                    sellItem(itemType); 
                    b.lastSoldTime = Date.now(); // Trigger Animation
                    return true; 
                }
                if (b.type.id.includes('cnc')) {
                    if (itemType === ITEM.STEEL && b.inventory[ITEM.STEEL] < 5) { b.inventory[ITEM.STEEL]++; return true; }
                }
                if (b.type.id.includes('press')) {
                    if (itemType === ITEM.PLASTIC && b.inventory[ITEM.PLASTIC] < 20) { b.inventory[ITEM.PLASTIC]++; return true; }
                    if (itemType === ITEM.MOLD && b.inventory[ITEM.MOLD] < 5) { b.inventory[ITEM.MOLD]++; return true; }
                    // Only MEGA PRESS can accept MOLD_QUAD
                    if (itemType === ITEM.MOLD_QUAD && b.type.id === 'press_mega' && b.inventory[ITEM.MOLD_QUAD] < 5) { b.inventory[ITEM.MOLD_QUAD]++; return true; }
                }
                if (b.type.transportSpeed) {
                    if (isSpaceFree(pos.x, pos.y)) { 
                        let it = new Item(itemType, pos.x, pos.y);
                        // Item entering belt from arm: set sourceDir based on Arm Rotation
                        // Arm is at this.x, this.y with this.rot
                        // Drop is at pos.x, pos.y
                        // Source dir relative to new tile is (ArmRot + 2)%4
                        it.sourceDir = (this.rot + 2) % 4;
                        items.push(it); 
                        return true; 
                    }
                }
                return false;
            }
        }

        class Item {
            constructor(type, x, y) {
                this.type = type; this.x = x; this.y = y; this.progress = 0; this.markedForDeletion = false; 
                this.exitDir = null; this.sourceDir = null; // sourceDir: 0=R,1=D,2=L,3=U (Where it came FROM)
            }
            update() {
                let gx = Math.floor(this.x), gy = Math.floor(this.y);
                if (!isValid({x:gx, y:gy})) { this.markedForDeletion = true; return; }
                let tile = grid[gy][gx];
                if (!tile.building || !tile.building.type.transportSpeed) { this.markedForDeletion = true; return; }
                
                let speed = tile.building.type.transportSpeed;
                if (this.exitDir === null) this.exitDir = tile.building.rot; 
                
                // Determine Source Dir if null (just spawned or glitch)
                if (this.sourceDir === null) {
                    // Assume it came from opposite of exit if unsure, or behind
                    this.sourceDir = (this.exitDir + 2) % 4;
                }

                let dir = this.exitDir;
                let nextX = gx, nextY = gy;
                if (dir === 0) nextX++; if (dir === 1) nextY++; if (dir === 2) nextX--; if (dir === 3) nextY--;
                
                let blocked = false;
                let nextTile = isValid({x:nextX, y:nextY}) ? grid[nextY][nextX] : null;
                if (!nextTile || !nextTile.building || !nextTile.building.type.transportSpeed) {
                    if (this.progress > 0.9) blocked = true;
                }
                for (let other of items) {
                    if (other === this) continue;
                    if (Math.floor(other.x) === gx && Math.floor(other.y) === gy && other.progress > this.progress) {
                        if (other.progress - this.progress < 0.6) blocked = true;
                    }
                    if (Math.floor(other.x) === nextX && Math.floor(other.y) === nextY) {
                        if (this.progress > 0.8 && other.progress < 0.2) blocked = true;
                    }
                }
                if (!blocked) {
                    this.progress += speed;
                    if (this.progress >= 1.0) {
                        if (nextTile && nextTile.building && nextTile.building.type.transportSpeed) {
                            this.x = nextX; this.y = nextY; this.progress = 0; 
                            // New source dir is opposite of where we came from (which was 'dir')
                            this.sourceDir = (dir + 2) % 4; 
                            this.exitDir = null;
                        } else this.progress = 1.0;
                    }
                }
            }
        }

        // --- Core ---
        function isValid(pos) { return pos.x >= 0 && pos.x < GRID_W && pos.y >= 0 && pos.y < GRID_H; }
        function getNeighbor(x, y, rot) {
            if (rot === 0) return { x: x + 1, y: y };
            if (rot === 1) return { x: x, y: y + 1 };
            if (rot === 2) return { x: x - 1, y: y };
            if (rot === 3) return { x: x, y: y - 1 };
            return { x, y };
        }
        function getNeighborAtDistance(x, y, rot, distance) {
            // Get neighbor at specified distance (1 = adjacent, 2 = 2 tiles away, etc.)
            if (rot === 0) return { x: x + distance, y: y };
            if (rot === 1) return { x: x, y: y + distance };
            if (rot === 2) return { x: x - distance, y: y };
            if (rot === 3) return { x: x, y: y - distance };
            return { x, y };
        }
        function isSpaceFree(x, y) {
            for (let it of items) {
                if (Math.floor(it.x) === x && Math.floor(it.y) === y && it.progress < 0.5) return false;
            }
            return true;
        }

        function init() {
            canvas = document.getElementById('gameCanvas');
            canvas.width = TILE_SIZE * GRID_W;
            canvas.height = TILE_SIZE * GRID_H;
            ctx = canvas.getContext('2d');
            gPlasticCanvas = document.getElementById('graphPlastic'); gPlasticCtx = gPlasticCanvas.getContext('2d');
            gSteelCanvas = document.getElementById('graphSteel'); gSteelCtx = gSteelCanvas.getContext('2d');
            gToolCanvas = document.getElementById('graphTooling'); gToolCtx = gToolCanvas.getContext('2d');
            gPartsCanvas = document.getElementById('graphParts'); gPartsCtx = gPartsCanvas.getContext('2d');
            gRevCanvas = document.getElementById('graphRevenue'); gRevCtx = gRevCanvas.getContext('2d');

            // Initialize gauge canvases
            ['plastic', 'steel', 'mold', 'part', 'revenue'].forEach(type => {
                const key = type === 'revenue' ? 'dollars' : type;
                const container = document.getElementById(`gauge-${type}`);
                const canvas = container.querySelector('.gauge-canvas');
                gaugeCtxs[key] = canvas.getContext('2d');
            });

            for (let y = 0; y < GRID_H; y++) {
                let row = []; for (let x = 0; x < GRID_W; x++) row.push(new Tile(x, y));
                grid.push(row);
            }

            // Initialize new toolbar system
            initToolbar();

            window.addEventListener('keydown', handleKey);
            canvas.addEventListener('mousedown', handleMouse);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', () => isDragging = false);
            canvas.addEventListener('contextmenu', e => e.preventDefault());

            // Old inspector event delegation removed - now handled in inspect panels

            // Auto-save before page unload
            window.addEventListener('beforeunload', saveGameState);

            // Exit inspect mode button
            document.getElementById('exit-inspect-btn').addEventListener('click', exitInspectMode);

            // Attach filter button event listeners once
            const filters = [
                { id: null, dataFilter: 'all' },
                { id: ITEM.PLASTIC, dataFilter: 'plastic' },
                { id: ITEM.STEEL, dataFilter: 'steel' },
                { id: ITEM.MOLD, dataFilter: 'mold' },
                { id: ITEM.MOLD_QUAD, dataFilter: 'mold_quad' },
                { id: ITEM.PART, dataFilter: 'part' }
            ];
            filters.forEach(f => {
                const btn = document.getElementById(`filter-btn-${f.dataFilter}`);
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (inspectedBuilding) {
                            inspectedBuilding.filter = f.id;
                            updateInspectPanelValues(inspectedBuilding);
                        }
                    });
                }
            });

            // Attach direction button event listeners once
            const directions = [
                { id: 'dir-btn-right', dir: 0 },  // RIGHT
                { id: 'dir-btn-down', dir: 1 },   // DOWN
                { id: 'dir-btn-left', dir: 2 },   // LEFT
                { id: 'dir-btn-up', dir: 3 }      // UP
            ];
            directions.forEach(d => {
                const btn = document.getElementById(d.id);
                if (btn) {
                    btn.addEventListener('click', () => {
                        if (inspectedBuilding) {
                            setArmDirection(d.dir);
                        }
                    });
                }
            });

            // Attach rotation button event listeners once
            const rotateCCWBtn = document.getElementById('rotate-ccw-btn');
            const rotateCWBtn = document.getElementById('rotate-cw-btn');
            if (rotateCCWBtn) {
                rotateCCWBtn.addEventListener('click', () => {
                    if (inspectedBuilding) {
                        rotateBuilding(inspectedBuilding, -1);  // Counter-clockwise
                    }
                });
            }
            if (rotateCWBtn) {
                rotateCWBtn.addEventListener('click', () => {
                    if (inspectedBuilding) {
                        rotateBuilding(inspectedBuilding, 1);  // Clockwise
                    }
                });
            }

            // Attach inventory delete button event listeners once
            const invItems = ['plastic', 'steel', 'mold', 'mold_quad', 'part', 'part_quad'];
            invItems.forEach(item => {
                const slot = document.getElementById(`inv-slot-${item}`);
                if (slot) {
                    const deleteBtn = slot.querySelector('.inv-delete');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', () => {
                            if (inspectedBuilding) {
                                clearInv(item);
                            }
                        });
                    }
                }
            });

            // Attach output delete button event listener once
            const outputDeleteBtn = document.getElementById('output-delete');
            if (outputDeleteBtn) {
                outputDeleteBtn.addEventListener('click', () => {
                    if (inspectedBuilding) {
                        clearOutput();
                    }
                });
            }

            setInterval(update, TICK_RATE);
            setInterval(updateMetrics, 1000);
            setInterval(updateInspectorUI, 200);
            setInterval(() => {
                // Update inspect panel values only (no DOM destruction)
                if (isInspectMode && inspectedBuilding) {
                    updateInspectPanelValues(inspectedBuilding);
                }
            }, 500);
            requestAnimationFrame(draw);

            // Auto-load saved game if exists
            if (loadGameState()) {
                gameRunning = true;
                document.getElementById('modal-overlay').style.display = 'none';
            } else {
                // No saved game, show intro modal so user can start fresh
                document.getElementById('modal-overlay').style.display = 'flex';
                document.getElementById('intro-modal').style.display = 'block';
                // Initialize toolbar to slot 1 for fresh game
                switchToSlot(1);
            }

            // Initial gauge draw
            drawAllGauges();
        }

        function startGame() {
            document.getElementById('intro-modal').parentElement.style.display = 'none';
            gameRunning = true; startTime = Date.now();
        }

        function continueGame() {
             document.getElementById('modal-overlay').style.display = 'none';
             gameRunning = true;
        }

        // --- Save/Load System ---
        function saveGameState() {
            const state = {
                buildings: buildings.map(b => ({
                    type: b.type.id,
                    x: b.x,
                    y: b.y,
                    rot: b.rot,
                    deliverDir: b.deliverDir,
                    inventory: b.inventory,
                    outputBuffer: b.outputBuffer,
                    outputCount: b.outputCount,
                    timer: b.timer,
                    moldLife: b.moldLife,
                    currentMoldType: b.currentMoldType
                })),
                items: items.map(i => ({
                    type: i.type,
                    x: i.x,
                    y: i.y,
                    targetX: i.targetX,
                    targetY: i.targetY,
                    progress: i.progress
                })),
                money,
                lifetimeRevenue,
                partsSoldTotal,
                totalPlasticUsed,
                totalSteelUsed,
                totalMoldsMade,
                level,
                currentTab,
                selectedSlot,
                selectedVariants,
                hasWon,
                elapsedTime: Date.now() - startTime,
                metricsHistory: metrics.history
            };
            localStorage.setItem('injectionMoldingSave', JSON.stringify(state));
        }

        function loadGameState() {
            const saved = localStorage.getItem('injectionMoldingSave');
            if (!saved) return false;

            try {
                const state = JSON.parse(saved);

                // Don't load if save is empty (no buildings placed)
                if (!state.buildings || state.buildings.length === 0) {
                    localStorage.removeItem('injectionMoldingSave');
                    return false;
                }

                // Restore buildings
                buildings = state.buildings.map(b => {
                    const type = Object.values(BUILDINGS).find(t => t.id === b.type);
                    if (!type) return null;

                    // Skip buildings outside current grid bounds
                    if (b.y < 0 || b.y >= GRID_H || b.x < 0 || b.x >= GRID_W) {
                        console.warn(`Skipping building at (${b.x}, ${b.y}) - outside grid bounds`);
                        return null;
                    }

                    const building = new Building(type, b.x, b.y, b.rot);
                    building.deliverDir = b.deliverDir !== undefined ? b.deliverDir : b.rot;
                    building.inventory = b.inventory || {};
                    building.outputBuffer = b.outputBuffer;
                    building.outputCount = b.outputCount || 0;
                    building.timer = b.timer || 0;
                    building.moldLife = b.moldLife || 0;
                    building.currentMoldType = b.currentMoldType;
                    grid[b.y][b.x].building = building;
                    return building;
                }).filter(b => b !== null);

                // Restore items
                items = state.items.map(i => {
                    // Skip items outside grid bounds (in pixels)
                    const maxX = GRID_W * TILE_SIZE;
                    const maxY = GRID_H * TILE_SIZE;
                    if (i.x < 0 || i.x > maxX || i.y < 0 || i.y > maxY) {
                        return null;
                    }

                    const item = new Item(i.type, i.x, i.y);
                    item.targetX = i.targetX;
                    item.targetY = i.targetY;
                    item.progress = i.progress || 0;
                    return item;
                }).filter(i => i !== null);

                // Restore game state
                money = state.money;
                lifetimeRevenue = state.lifetimeRevenue;
                partsSoldTotal = state.partsSoldTotal;
                totalPlasticUsed = state.totalPlasticUsed;
                totalSteelUsed = state.totalSteelUsed;
                totalMoldsMade = state.totalMoldsMade;
                level = state.level;
                currentTab = state.currentTab || 1;
                selectedSlot = state.selectedSlot || 1;
                selectedVariants = state.selectedVariants || selectedVariants;
                hasWon = state.hasWon || false;

                // Update toolbar to reflect loaded state
                updateVariantLockStatus();
                updateToolbarDisplay();

                // Restore full toolbar state (selectedTool, info card, flyout)
                switchToSlot(selectedSlot);

                metrics.history = state.metricsHistory || [];

                // Restore time (adjust startTime to account for elapsed time)
                startTime = Date.now() - (state.elapsedTime || 0);

                updateUI();
                return true;
            } catch (e) {
                console.error('Failed to load save:', e);
                return false;
            }
        }

        function resetGame() {
            // Remove auto-save listener to prevent re-saving during reload
            window.removeEventListener('beforeunload', saveGameState);
            localStorage.removeItem('injectionMoldingSave');
            location.reload();
        }

        function sellItem(type) {
            let val = SELL_PRICES[type];
            money += val;
            lifetimeRevenue += val;
            metrics.current.dollars += val;
            if (type === ITEM.PART) { partsSoldTotal++; checkLevelUp(); }
            if (money >= 1000000 && !hasWon) {
                 hasWon = true;
                 endGame();
            }
            updateUI();
        }

        function checkLevelUp() {
            let nextLvl = level + 1;
            if (LEVELS[nextLvl] && partsSoldTotal >= LEVELS[nextLvl].reqParts) {
                level = nextLvl;
                showNotification(`LEVEL ${level} UNLOCKED`);

                // Update toolbar to show newly unlocked variants
                updateVariantLockStatus();
            }
        }

        function update() {
            if (!gameRunning) return;
            let diff = Math.floor((Date.now() - startTime) / 1000);
            let m = Math.floor(diff/60).toString().padStart(2,'0');
            let s = (diff%60).toString().padStart(2,'0');
            document.getElementById('timeDisplay').innerText = `${m}:${s}`;
            for (let b of buildings) b.update();
            items = items.filter(i => !i.markedForDeletion);
            for (let i of items) i.update();
        }

        function updateMetrics() {
            if (!gameRunning) return;
            metrics.history.push({ ...metrics.current });
            if (metrics.history.length > 60) metrics.history.shift();
            metrics.current = { plastic: 0, steel: 0, mold: 0, part: 0, dollars: 0 };
            drawGraphs();
            drawAllGauges();
        }

        // --- Interaction ---
        // OLD TOOLBAR FUNCTIONS - NO LONGER USED
        // function switchTab(t) { ... }  // Removed - tabs no longer exist
        // function renderLockedToolbar(count) { ... }  // Removed - old toolbar system
        // function setupToolbar() { ... }  // Removed - replaced by initToolbar

        // ============================================
        // NEW TOOLBAR SYSTEM FUNCTIONS
        // ============================================

        function switchToSlot(slotNumber) {
            selectedSlot = slotNumber;
            const flyout = document.getElementById('flyout-panel');

            // Fade out animation
            flyout.classList.add('fading');

            // Wait for fade, then update
            setTimeout(() => {
                updateFlyoutDisplay(slotNumber);
                flyout.classList.remove('fading');  // Fade in
            }, 100);

            updateToolbarDisplay();

            // Update selectedTool to the currently selected variant for this slot
            const variantId = selectedVariants[slotNumber];
            const building = ALL_BUILDINGS[variantId];
            if (building) {
                selectedTool = building.id;
                updateInfoCard(building);
            }
        }

        function selectVariant(slotNumber, buildingId) {
            const building = ALL_BUILDINGS[buildingId];

            // Check if unlocked
            if (building.reqLevel > level) {
                showNotification(`UNLOCK AT LEVEL ${building.reqLevel}`);
                return;
            }

            // Update selection
            selectedVariants[slotNumber] = buildingId;
            selectedTool = building.id;

            // Update displays
            updateToolbarDisplay();
            updateVariantSelection();
            updateInfoCard(building);

            // Save to localStorage
            saveGameState();

            // Show feedback
            showNotification(`${building.name} SELECTED`);
        }

        function cycleVariant(slotNumber) {
            const slot = BUILDING_SLOTS.find(s => s.slot === slotNumber);
            if (!slot) return;

            // Get unlocked variants only
            const unlockedVariants = slot.variants.filter(vId => {
                const variant = ALL_BUILDINGS[vId];
                return variant.reqLevel <= level;
            });

            if (unlockedVariants.length === 0) return;

            // Find current index
            const currentVariant = selectedVariants[slotNumber];
            const currentIndex = unlockedVariants.indexOf(currentVariant);

            // Cycle to next
            const nextIndex = (currentIndex + 1) % unlockedVariants.length;
            const nextVariant = unlockedVariants[nextIndex];

            // Select it
            selectVariant(slotNumber, nextVariant);
        }

        function updateFlyoutDisplay(slotNumber) {
            // Update header
            const slot = BUILDING_SLOTS.find(s => s.slot === slotNumber);
            if (!slot) return;

            document.getElementById('flyout-header').textContent = `${slot.name} VARIANTS`;

            // Show/hide variants based on slot
            document.querySelectorAll('.flyout-variant').forEach(variant => {
                if (parseInt(variant.dataset.slot) === slotNumber) {
                    variant.classList.remove('hidden');
                } else {
                    variant.classList.add('hidden');
                }
            });

            // Update lock status based on current level
            updateVariantLockStatus();

            // Update selection indicators
            updateVariantSelection();
        }

        function updateVariantLockStatus() {
            document.querySelectorAll('.flyout-variant').forEach(variant => {
                const buildingId = variant.dataset.building;
                const building = ALL_BUILDINGS[buildingId];

                if (building.reqLevel > level) {
                    variant.classList.add('locked');
                } else {
                    variant.classList.remove('locked');
                }
            });
        }

        function updateVariantSelection() {
            document.querySelectorAll('.flyout-variant').forEach(variant => {
                const slotNum = parseInt(variant.dataset.slot);
                const buildingId = variant.dataset.building;

                if (selectedVariants[slotNum] === buildingId) {
                    variant.classList.add('selected');
                } else {
                    variant.classList.remove('selected');
                }
            });
        }

        function updateToolbarDisplay() {
            document.querySelectorAll('.tool-slot').forEach(slotEl => {
                const slotNum = parseInt(slotEl.dataset.slot);
                const selectedBuildingId = selectedVariants[slotNum];
                const building = ALL_BUILDINGS[selectedBuildingId];

                if (building) {
                    // Update icon and name to show selected variant
                    slotEl.querySelector('.tool-icon').textContent = building.icon;
                    slotEl.querySelector('.tool-name').textContent = building.name;
                }

                // Highlight active slot
                if (slotNum === selectedSlot) {
                    slotEl.classList.add('selected');
                } else {
                    slotEl.classList.remove('selected');
                }
            });
        }

        function initToolbar() {
            // Tool slot clicks
            document.querySelectorAll('.tool-slot').forEach(slotEl => {
                slotEl.addEventListener('click', () => {
                    const slotNum = parseInt(slotEl.dataset.slot);
                    switchToSlot(slotNum);
                });
            });

            // Variant clicks
            document.querySelectorAll('.flyout-variant').forEach(variantEl => {
                variantEl.addEventListener('click', () => {
                    if (variantEl.classList.contains('locked')) return;

                    const slotNum = parseInt(variantEl.dataset.slot);
                    const buildingId = variantEl.dataset.building;
                    selectVariant(slotNum, buildingId);
                });
            });

            // Initialize display - don't call switchToSlot here, let loadGameState handle it
            // If no saved game, init() will call switchToSlot(1) after checking
            updateVariantLockStatus();
        }

        // ============================================
        // OLD TOOLBAR SYSTEM - FUNCTIONS REMOVED
        // ============================================
        // renderLockedToolbar() - removed
        // setupToolbar() - removed

        function updateInfoCard(b) {
            document.getElementById('card-icon').innerText = b.icon;
            document.getElementById('card-icon').style.color = b.color;
            document.getElementById('card-title').innerText = b.name;
            document.getElementById('card-desc').innerText = b.desc;
            
            // Show Status Legend for Machines, Sources, Bins. Hide for Belts and Arms.
            if (!b.id.includes('belt') && !b.isArm) {
                document.getElementById('status-legend').style.display = 'flex';
            } else {
                document.getElementById('status-legend').style.display = 'none';
            }
        }

        function handleKey(e) {
            // Toggle debug panel with backtick key
            if (e.key === '`') {
                toggleDebugPanel();
                return;
            }
            if (e.key.toLowerCase() === 'i') {
                // Update button visibility based on game state
                const isGameActive = gameRunning || startTime > 0;
                document.getElementById('btn-start').style.display = isGameActive ? 'none' : 'block';
                document.getElementById('btn-continue').style.display = isGameActive ? 'block' : 'none';
                document.getElementById('btn-reset').style.display = isGameActive ? 'block' : 'none';

                document.getElementById('modal-overlay').style.display = 'flex';
                document.getElementById('intro-modal').style.display = 'block';
                document.getElementById('win-modal').style.display = 'none';
                return;
            }
            if (e.key.toLowerCase() === 'v') {
                // Show victory report card
                if (gameRunning || startTime > 0) {
                    populateVictoryReport();
                    document.getElementById('modal-overlay').style.display = 'flex';
                    document.getElementById('intro-modal').style.display = 'none';
                    document.getElementById('win-modal').style.display = 'flex';
                    gameRunning = false;
                }
                return;
            }
            if (e.key === 'Shift' || e.key === 'Alt') return;

            if (e.key.toLowerCase() === 'r') rotation = (rotation + 1) % 4;
            if (e.key === 'Escape') {
                if (isInspectMode) exitInspectMode();
            }

            // New toolbar keyboard controls
            if (e.code.startsWith('Digit')) {
                let num = parseInt(e.code.replace('Digit',''));
                if (!isNaN(num) && num >= 1 && num <= 7) {
                    // Shift+Number: Quick cycle variant within slot
                    if (e.shiftKey && !e.altKey) {
                        cycleVariant(num);
                        return;
                    }

                    // Alt+Number: Select variant from current flyout (1-4)
                    if (e.altKey && !e.shiftKey && num >= 1 && num <= 4) {
                        e.preventDefault();  // Prevent browser Alt shortcuts

                        const currentSlot = BUILDING_SLOTS.find(s => s.slot === selectedSlot);
                        if (currentSlot && currentSlot.variants[num - 1]) {
                            selectVariant(selectedSlot, currentSlot.variants[num - 1]);
                        } else {
                            showNotification("VARIANT NOT AVAILABLE");
                        }
                        return;
                    }

                    // Plain Number (1-7): Switch slot (updates flyout) and exit inspect mode
                    if (!e.shiftKey && !e.altKey) {
                        if (isInspectMode) exitInspectMode();
                        switchToSlot(num);
                        return;
                    }
                }
            }
        }

        function getMouseGridPos(e) {
            const rect = canvas.getBoundingClientRect();
            // Account for CSS scaling of the canvas
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: Math.floor((e.clientX - rect.left) * scaleX / TILE_SIZE),
                y: Math.floor((e.clientY - rect.top) * scaleY / TILE_SIZE)
            };
        }

        function handleMouse(e) {
            if (!gameRunning) return;
            const pos = getMouseGridPos(e);

            if (e.button === 0) {
                if (!grid[pos.y] || !grid[pos.y][pos.x]) return;
                const tile = grid[pos.y][pos.x];

                if (isInspectMode) {
                    // Inspect Mode: clicking building switches inspection, empty tile does nothing
                    if (tile.building) {
                        enterInspectMode(tile.building);
                    }
                    // Empty tile click does nothing in inspect mode
                } else {
                    // Build Mode: clicking building enters inspect mode, empty tile places building
                    if (tile.building) {
                        enterInspectMode(tile.building);
                    } else {
                        placeBuilding(pos.x, pos.y);
                        isDragging = true;
                    }
                }
            } else if (e.button === 2) {
                if (isInspectMode) {
                    exitInspectMode();
                } else {
                    removeBuilding(pos.x, pos.y);
                }
            }
        }

        function handleMouseMove(e) {
            mouseGridPos = getMouseGridPos(e);
            if (isDragging && gameRunning) placeBuilding(mouseGridPos.x, mouseGridPos.y);
        }

        function placeBuilding(x, y) {
            if (!isValid({x,y})) return;
            const tile = grid[y][x];
            let bData = Object.values(BUILDINGS).find(b => b.id === selectedTool);
            if (tile.building) {
                if (tile.building.type.id === bData.id && tile.building.rot === rotation) return;
                return;
            }
            if (money >= bData.cost) {
                money -= bData.cost;
                tile.building = new Building(bData, x, y, rotation);
                buildings.push(tile.building);
                updateUI();
            } else showNotification("INSUFFICIENT FUNDS");
        }

        function removeBuilding(x, y) {
            if (!isValid({x,y})) return;
            const tile = grid[y][x];
            if (tile.building) {
                money += Math.floor(tile.building.type.cost * 0.5);
                buildings = buildings.filter(b => b !== tile.building);
                tile.building = null;
                updateUI();
            }
        }

        function openInspector(b) {
            inspectedBuilding = b;
            let insp = document.getElementById('inspector');
            insp.style.display = 'block';
            document.getElementById('insp-name').innerText = b.type.name;

            // Position inspector near the building
            let buildingX = b.x * TILE_SIZE;
            let buildingY = b.y * TILE_SIZE;

            // Try to position to the right of the building
            let inspX = buildingX + TILE_SIZE + 10;
            let inspY = buildingY;

            // Get inspector dimensions (approximate if not yet rendered)
            let inspWidth = 180;
            let inspHeight = insp.offsetHeight || 150;

            // Check if inspector would go off-screen to the right
            if (inspX + inspWidth > GRID_W * TILE_SIZE) {
                // Position to the left instead
                inspX = buildingX - inspWidth - 10;
            }

            // Check if inspector would go off-screen to the left
            if (inspX < 0) {
                // Position below the building instead
                inspX = buildingX;
                inspY = buildingY + TILE_SIZE + 10;
            }

            // Check if inspector would go off-screen at the bottom
            if (inspY + inspHeight > GRID_H * TILE_SIZE) {
                // Move up to fit
                inspY = GRID_H * TILE_SIZE - inspHeight - 10;
            }

            // Ensure it doesn't go above the top
            if (inspY < 0) inspY = 10;

            insp.style.left = inspX + 'px';
            insp.style.top = inspY + 'px';
            insp.style.right = 'auto'; // Clear the fixed right position

            updateInspectorUI();
        }
        function closeInspector() { inspectedBuilding = null; document.getElementById('inspector').style.display = 'none'; }

        // ===== INSPECT MODE =====
        function enterInspectMode(building) {
            isInspectMode = true;
            inspectedBuilding = building;

            // Update inspect mode header
            document.getElementById('inspect-mode-header').textContent = `INSPECTING: ${building.type.name}`;

            // Dim the left toolbar (make it clear tools aren't selectable)
            document.getElementById('left-toolbar').classList.add('dimmed');

            // Hide build mode, show inspect mode
            document.getElementById('build-mode').style.display = 'none';
            document.getElementById('inspect-mode').style.display = 'flex';

            // Show/hide relevant panels based on building type
            showHideInspectPanels(building);

            // Initial value update
            updateInspectPanelValues(building);
        }

        function exitInspectMode() {
            isInspectMode = false;
            inspectedBuilding = null;

            // Un-dim the left toolbar (tools are selectable again)
            document.getElementById('left-toolbar').classList.remove('dimmed');

            // Hide inspect mode, show build mode
            document.getElementById('inspect-mode').style.display = 'none';
            document.getElementById('build-mode').style.display = 'flex';
        }

        function getBuildingStatus(building) {
            // Check for output full (highest priority after errors)
            if (building.outputBuffer && building.outputCount >= 5) {
                return 'OUTPUT FULL';
            }

            // Check for press-specific errors
            if (building.type.id.includes('press')) {
                if (building.inventory[ITEM.PLASTIC] === 0) {
                    return 'NO PLASTIC';
                }
                if (building.moldLife <= 0 && building.inventory[ITEM.MOLD] === 0) {
                    return 'NO MOLD';
                }
            }

            // Check for CNC-specific errors
            if (building.type.id.includes('cnc')) {
                if (building.inventory[ITEM.STEEL] === 0) {
                    return 'NO STEEL';
                }
            }

            // Generic check for missing inputs (other building types)
            if (building.type.inputs && !building.type.id.includes('src')) {
                for (let input of building.type.inputs) {
                    if (building.inventory[input] <= 0) {
                        return 'NO INPUT';
                    }
                }
            }

            return 'OPERATIONAL';
        }

        function clearInv(type) {
            if (inspectedBuilding && inspectedBuilding.inventory.hasOwnProperty(type)) {
                inspectedBuilding.inventory[type] = 0;
                if (isInspectMode) updateInspectPanelValues(inspectedBuilding);
            }
        }
        function clearOutput() {
            if (inspectedBuilding) {
                inspectedBuilding.outputBuffer = null;
                inspectedBuilding.outputCount = 0;
            }
            if (isInspectMode) updateInspectPanelValues(inspectedBuilding);
        }

        function setArmDirection(dir) {
            if (inspectedBuilding) {
                inspectedBuilding.deliverDir = dir;
                const dirNames = ['RIGHT', 'DOWN', 'LEFT', 'UP'];
                showNotification(`ARM DIRECTION: ${dirNames[dir]}`);
                // Update button highlighting
                if (isInspectMode) updateInspectPanelValues(inspectedBuilding);
            }
        }

        function rotateBuilding(building, direction) {
            // direction: 1 for clockwise, -1 for counter-clockwise

            // Calculate 10% cost
            const cost = Math.floor(building.type.cost * 0.10);

            // Check for insufficient funds
            if (money < cost) {
                showNotification("INSUFFICIENT FUNDS");
                return;
            }

            // Deduct cost
            money -= cost;

            // Rotate building
            building.rot = (building.rot + direction + 4) % 4;  // +4 to handle negative modulo

            // If arm with canDirectDeliver, rotate deliverDir too
            if (building.type.canDirectDeliver) {
                building.deliverDir = (building.deliverDir + direction + 4) % 4;
            }

            // If belt (has transportSpeed), rotate items on this tile
            if (building.type.transportSpeed) {
                // Find all items on this tile
                const buildingX = building.x;
                const buildingY = building.y;
                for (let item of items) {
                    const itemGx = Math.floor(item.x);
                    const itemGy = Math.floor(item.y);
                    if (itemGx === buildingX && itemGy === buildingY) {
                        // Rotate item's exitDir
                        item.exitDir = (item.exitDir + direction + 4) % 4;
                    }
                }
            }

            // Show notification
            const rotName = direction === 1 ? "CLOCKWISE" : "COUNTER-CLOCKWISE";
            showNotification(`ROTATED ${rotName} - $${cost}`);

            // Update UI
            updateUI();
            if (isInspectMode) updateInspectPanelValues(inspectedBuilding);
        }

        // Old updateInspectorUI removed - now handled by updateInspectPanels
        function updateInspectorUI() {
            // Stub - old inspector removed, new inspect panels use updateInspectPanels()
        }

        // ===== PERSISTENT INSPECT PANELS (No DOM destruction) =====

        function showHideInspectPanels(building) {
            // Status panel always visible
            document.getElementById('status-panel').style.display = 'block';

            // Rotation panel - hide for sellers (bins)
            const canRotate = building.type.id !== 'bin';
            document.getElementById('rotation-panel').style.display = canRotate ? 'block' : 'none';

            // Buffer panel - show if building has inputs or outputs
            const hasBuffers = building.type.inputs || building.outputBuffer !== undefined;
            document.getElementById('buffer-panel').style.display = hasBuffers ? 'block' : 'none';

            // Filter panel - show if building can filter
            document.getElementById('filter-panel').style.display = building.type.canFilter ? 'block' : 'none';

            // Direction panel - show if building can direct deliver
            document.getElementById('direction-panel').style.display = building.type.canDirectDeliver ? 'block' : 'none';
        }

        function updateInspectPanelValues(building) {
            if (!isInspectMode || !inspectedBuilding) return;

            // Update Status Panel
            const icon = building.type.icon || '?';
            const status = getBuildingStatus(building);
            // Status colors: green for operational, yellow for full, red for errors
            let statusColor = '#4caf50';  // Green for OPERATIONAL
            if (status === 'OUTPUT FULL') {
                statusColor = '#ffd700';  // Yellow/gold for full
            } else if (status !== 'OPERATIONAL') {
                statusColor = '#f44336';  // Red for errors (NO PLASTIC, NO MOLD, NO STEEL, NO INPUT)
            }

            document.getElementById('status-icon').textContent = icon;
            document.getElementById('status-name').textContent = building.type.name;
            const statusIndicator = document.getElementById('status-indicator');
            statusIndicator.textContent = `‚óè ${status}`;
            statusIndicator.style.color = statusColor;
            document.getElementById('status-position').textContent = `(${building.x}, ${building.y})`;
            document.getElementById('status-cycles').textContent = building.cycleCount || 0;

            // Update Rotation Panel costs
            const rotationCost = Math.floor(building.type.cost * 0.10);
            const rotateCostCCW = document.getElementById('rotate-cost-ccw');
            const rotateCostCW = document.getElementById('rotate-cost-cw');
            if (rotateCostCCW) rotateCostCCW.textContent = `$${rotationCost}`;
            if (rotateCostCW) rotateCostCW.textContent = `$${rotationCost}`;

            // Update Inventory Panel - show/hide persistent slots
            // Determine which inventory items to show (same logic as main)
            const invItems = ['plastic', 'steel', 'mold', 'mold_quad', 'part', 'part_quad'];
            invItems.forEach(item => {
                const slot = document.getElementById(`inv-slot-${item}`);
                if (!slot) return;

                // Check if this item should be shown for this building type
                let shouldShow = false;
                if (building.inventory && building.inventory[item] !== undefined) {
                    // Skip source buildings
                    if (building.type.id.includes('src')) {
                        shouldShow = false;
                    }
                    // CNC only shows steel
                    else if (building.type.id.includes('cnc') && item !== ITEM.STEEL) {
                        shouldShow = false;
                    }
                    // Press doesn't show steel
                    else if (building.type.id.includes('press') && item === ITEM.STEEL) {
                        shouldShow = false;
                    }
                    // Show if inventory exists for this item
                    else if (building.inventory[item] !== undefined) {
                        shouldShow = true;
                    }
                }

                // Show/hide slot and update count
                if (shouldShow) {
                    slot.style.display = 'flex';
                    const countSpan = slot.querySelector('.inv-count');
                    if (countSpan) {
                        countSpan.textContent = building.inventory[item] || 0;
                    }
                } else {
                    slot.style.display = 'none';
                }
            });

            // Update output section
            const hasOutput = building.type.output || building.type.recipe?.out;
            const outputSection = document.getElementById('output-section');
            if (outputSection) {
                if (hasOutput) {
                    outputSection.style.display = 'block';
                    const outType = building.outputBuffer ? building.outputBuffer.toUpperCase() : 'NONE';
                    const outCount = building.outputCount || 0;
                    const outputLabel = document.getElementById('output-label');
                    if (outputLabel) {
                        outputLabel.textContent = `${outType} (x${outCount})`;
                    }
                } else {
                    outputSection.style.display = 'none';
                }
            }

            // Update Filter Panel
            if (building.type.canFilter) {
                const filters = [null, ITEM.PLASTIC, ITEM.STEEL, ITEM.MOLD, ITEM.MOLD_QUAD, ITEM.PART];
                filters.forEach(f => {
                    const filterId = f || 'all';
                    const btn = document.getElementById(`filter-btn-${filterId}`);
                    if (btn) {
                        const isActive = building.filter === f;
                        if (isActive) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    }
                });
            }

            // Update Direction Panel
            if (building.type.canDirectDeliver) {
                const pickupDir = (building.rot + 2) % 4;  // Opposite of rotation
                const currentDir = building.deliverDir;

                const dirButtons = [
                    { id: 'dir-btn-right', dir: 0 },  // RIGHT
                    { id: 'dir-btn-down', dir: 1 },   // DOWN
                    { id: 'dir-btn-left', dir: 2 },   // LEFT
                    { id: 'dir-btn-up', dir: 3 }      // UP
                ];

                dirButtons.forEach(({ id, dir }) => {
                    const btn = document.getElementById(id);
                    if (btn) {
                        // Reset styles
                        btn.disabled = false;
                        btn.classList.remove('active');

                        // Disable pickup direction (can't deliver back where you're picking from)
                        if (dir === pickupDir) {
                            btn.disabled = true;
                        }

                        // Highlight current delivery direction
                        if (dir === currentDir) {
                            btn.classList.add('active');
                        }
                    }
                });
            }
        }

        function updateUI() {
            document.getElementById('moneyDisplay').innerText = `$${money.toLocaleString()}`;
            document.getElementById('levelDisplay').innerText = level;
            let nextReq = LEVELS[level + 1];
            document.getElementById('nextUnlockDisplay').innerText = nextReq ? `${nextReq.reqParts} PARTS` : "MAX";
        }
        function showNotification(msg) {
            let n = document.getElementById('notification');
            n.innerText = msg; n.style.opacity = 1;
            setTimeout(()=>n.style.opacity=0, 2000);
        }

        // Old arm config functions removed - functionality moved to unified inspect panel system
        let selectedArm = null;
        function openArmConfig(building) { enterInspectMode(building); }
        function closeArmConfig() { exitInspectMode(); }

        // Debug Panel Functions
        function toggleDebugPanel() {
            const panel = document.getElementById('debug-panel');
            if (panel.style.display === 'none') {
                syncDebugValues();
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        function syncDebugValues() {
            document.getElementById('debug-money').value = Math.floor(money);
            document.getElementById('debug-parts').value = partsSoldTotal;
            document.getElementById('debug-revenue').value = Math.floor(lifetimeRevenue);
            document.getElementById('debug-level').value = level;
        }

        function applyDebugMoney() {
            const val = parseInt(document.getElementById('debug-money').value) || 0;
            money = val;
            lifetimeRevenue = Math.max(lifetimeRevenue, money);
            updateUI();
            showNotification(`üí∞ Money set to $${val.toLocaleString()}`);
        }

        function applyDebugParts() {
            const val = parseInt(document.getElementById('debug-parts').value) || 0;
            partsSoldTotal = val;
            updateUI();
            showNotification(`‚≠ê Parts sold set to ${val.toLocaleString()}`);
        }

        function applyDebugRevenue() {
            const val = parseInt(document.getElementById('debug-revenue').value) || 0;
            lifetimeRevenue = val;
            money = Math.max(money, val); // Ensure current money isn't less than lifetime revenue
            checkVictory();
            updateUI();
            showNotification(`üìä Lifetime revenue set to $${val.toLocaleString()}`);
        }

        function applyDebugLevel() {
            const val = parseInt(document.getElementById('debug-level').value) || 1;
            const clampedLevel = Math.max(1, Math.min(5, val));
            level = clampedLevel;
            document.getElementById('debug-level').value = clampedLevel;
            updateToolbar();
            updateUI();
            showNotification(`üéöÔ∏è Level set to ${clampedLevel}`);
        }

        function populateVictoryReport() {
            // DEBUG: Log all values
            console.log('=== VICTORY REPORT DEBUG ===');
            console.log('lifetimeRevenue:', lifetimeRevenue);
            console.log('totalPlasticUsed:', totalPlasticUsed);
            console.log('totalSteelUsed:', totalSteelUsed);
            console.log('totalMoldsMade:', totalMoldsMade);
            console.log('partsSoldTotal:', partsSoldTotal);
            console.log('startTime:', startTime);
            console.log('Date.now():', Date.now());
            console.log('elapsedSec:', (Date.now() - startTime) / 1000);

            // Populate Report Stats
             document.getElementById('repRevenue').innerText = `$${lifetimeRevenue.toLocaleString()}`;
             document.getElementById('repTime').innerText = document.getElementById('timeDisplay').innerText;

             // Calculate Peak Rate from metrics history
             let maxRate = 0;
             metrics.history.forEach(m => {
                 let rate = m.part * 60;
                 if(rate > maxRate) maxRate = rate;
             });
             document.getElementById('repPeak').innerText = `${maxRate} PPM`;

             document.getElementById('repPlastic').innerText = totalPlasticUsed.toLocaleString();
             document.getElementById('repSteel').innerText = totalSteelUsed.toLocaleString();
             document.getElementById('repMolds').innerText = totalMoldsMade.toLocaleString();
             document.getElementById('repParts').innerText = partsSoldTotal.toLocaleString();

             // Calculate Grade
             let elapsedSec = (Date.now() - startTime) / 1000;
             let grade = 'F';
             if(elapsedSec < 900) grade = 'S'; // 15 mins
             else if(elapsedSec < 1500) grade = 'A'; // 25 mins
             else if(elapsedSec < 2100) grade = 'B'; // 35 mins
             else if(elapsedSec < 2700) grade = 'C'; // 45 mins
             else if(elapsedSec < 3300) grade = 'D'; // 55 mins
             // else F (65+ mins)
             console.log('Final grade:', grade);
             document.getElementById('gradeStamp').innerText = grade;

             // Date
             let d = new Date();
             document.getElementById('reportDate').innerText = d.toLocaleDateString().toUpperCase();
        }

        function endGame() {
             document.getElementById('modal-overlay').style.display = 'flex';
             document.getElementById('intro-modal').style.display = 'none';
             document.getElementById('win-modal').style.display = 'flex';
             gameRunning = false;

             populateVictoryReport();
        }

        function drawGraphs() {
            function drawBezier(ctx, data, color, maxVal) {
                if (data.length < 2) return;
                ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
                let w = ctx.canvas.width, h = ctx.canvas.height;
                let step = w / 60;
                let startY = h - (data[0] / maxVal) * h;
                ctx.moveTo(0, startY);
                for (let i = 0; i < data.length - 1; i++) {
                    let x1 = i * step, y1 = h - (data[i] / maxVal) * h;
                    let x2 = (i + 1) * step, y2 = h - (data[i + 1] / maxVal) * h;
                    let mx = (x1 + x2) / 2, my = (y1 + y2) / 2;
                    ctx.quadraticCurveTo(x1, y1, mx, my);
                }
                ctx.stroke();
                ctx.shadowBlur = 4; ctx.shadowColor = color; ctx.stroke(); ctx.shadowBlur = 0;
            }

            // Use smoothed EMA values for graphs (already in per-minute rate)
            let plastics = smoothedHistory.map(m => m.plastic);
            let steels = smoothedHistory.map(m => m.steel);
            let molds = smoothedHistory.map(m => m.mold);
            let parts = smoothedHistory.map(m => m.part);
            let dollars = smoothedHistory.map(m => m.dollars);

            let plasticsMax = Math.max(...plastics, 10);
            let plasticsScale = Math.ceil(plasticsMax / 10) * 10;

            let steelsMax = Math.max(...steels, 10);
            let steelsScale = Math.ceil(steelsMax / 10) * 10;

            let moldsMax = Math.max(...molds, 10);
            let moldsScale = Math.ceil(moldsMax / 10) * 10;

            let partsMax = Math.max(...parts, 10);
            let partsScale = Math.ceil(partsMax / 10) * 10;

            let dollarsMax = Math.max(...dollars, 10);
            let dollarsScale = Math.ceil(dollarsMax / 10) * 10;

            [gPlasticCtx, gSteelCtx, gToolCtx, gPartsCtx, gRevCtx].forEach(c => {
                c.fillStyle = '#051005'; c.fillRect(0,0,240,100);
                c.strokeStyle = '#0f200f'; c.beginPath();
                for(let i=0;i<240;i+=20) { c.moveTo(i,0); c.lineTo(i,100); }
                for(let i=0;i<100;i+=20) { c.moveTo(0,i); c.lineTo(240,i); }
                c.stroke();
            });

            // Draw graph lines first
            drawBezier(gPlasticCtx, plastics, C_PLASTIC, plasticsScale);
            drawBezier(gSteelCtx, steels, '#c0c0c0', steelsScale);
            drawBezier(gToolCtx, molds, '#2196f3', moldsScale);
            drawBezier(gPartsCtx, parts, C_PART, partsScale);
            drawBezier(gRevCtx, dollars, '#00ff00', dollarsScale);

            // Draw scale labels for plastic graph
            gPlasticCtx.font = '8px monospace';
            gPlasticCtx.fillStyle = '#051005';
            gPlasticCtx.fillRect(0, 2, 25, 10);
            gPlasticCtx.fillRect(0, 47, 25, 10);
            gPlasticCtx.fillStyle = '#00ff00';
            gPlasticCtx.fillText(plasticsScale, 2, 10);
            gPlasticCtx.fillText(plasticsScale/2, 2, 55);

            // Draw scale labels for steel graph
            gSteelCtx.font = '8px monospace';
            gSteelCtx.fillStyle = '#051005';
            gSteelCtx.fillRect(0, 2, 25, 10);
            gSteelCtx.fillRect(0, 47, 25, 10);
            gSteelCtx.fillStyle = '#00ff00';
            gSteelCtx.fillText(steelsScale, 2, 10);
            gSteelCtx.fillText(steelsScale/2, 2, 55);

            // Draw scale labels for tooling graph
            gToolCtx.font = '8px monospace';
            gToolCtx.fillStyle = '#051005';
            gToolCtx.fillRect(0, 2, 25, 10);
            gToolCtx.fillRect(0, 47, 25, 10);
            gToolCtx.fillStyle = '#00ff00';
            gToolCtx.fillText(moldsScale, 2, 10);
            gToolCtx.fillText(moldsScale/2, 2, 55);

            // Draw scale labels for parts graph
            gPartsCtx.font = '8px monospace';
            gPartsCtx.fillStyle = '#051005';
            gPartsCtx.fillRect(0, 2, 25, 10);
            gPartsCtx.fillRect(0, 47, 25, 10);
            gPartsCtx.fillStyle = '#00ff00';
            gPartsCtx.fillText(partsScale, 2, 10);
            gPartsCtx.fillText(partsScale/2, 2, 55);

            // Draw scale labels for revenue graph
            gRevCtx.font = '8px monospace';
            // Draw dark background behind text for contrast
            gRevCtx.fillStyle = '#051005';
            gRevCtx.fillRect(0, 2, 30, 10);
            gRevCtx.fillRect(0, 47, 30, 10);
            // Draw text
            gRevCtx.fillStyle = '#00ff00';
            gRevCtx.fillText(dollarsScale, 2, 10);
            gRevCtx.fillText(dollarsScale/2, 2, 55);
        }

        function drawGauge(ctx, value, maxVal, color) {
            const w = ctx.canvas.width;
            const h = ctx.canvas.height;
            const cx = w / 2;
            const cy = h / 2 + 5;
            const radius = 40;
            const segmentCount = 30;
            const startAngle = Math.PI * 0.75;  // 135 degrees
            const endAngle = Math.PI * 2.25;    // 405 degrees (270¬∞ arc)
            const arcLength = endAngle - startAngle;

            // Clear
            ctx.fillStyle = '#1a1a1a';
            ctx.fillRect(0, 0, w, h);

            // Draw segments
            const segmentAngle = arcLength / segmentCount;
            const filledSegments = Math.min(Math.round((value / maxVal) * segmentCount), segmentCount);

            for (let i = 0; i < segmentCount; i++) {
                const angle = startAngle + i * segmentAngle;
                const isFilled = i < filledSegments;

                ctx.beginPath();
                ctx.arc(cx, cy, radius, angle, angle + segmentAngle * 0.8, false);
                ctx.arc(cx, cy, radius - 8, angle + segmentAngle * 0.8, angle, true);
                ctx.closePath();

                if (isFilled) {
                    ctx.fillStyle = color;
                    ctx.shadowBlur = 4;
                    ctx.shadowColor = color;
                } else {
                    ctx.fillStyle = '#333';
                    ctx.shadowBlur = 0;
                }
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            // Digital readout
            ctx.fillStyle = color;
            ctx.font = 'bold 16px "Courier New"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.shadowBlur = 6;
            ctx.shadowColor = color;
            ctx.fillText(Math.round(value), cx, cy);
            ctx.shadowBlur = 0;

            // Unit label
            ctx.fillStyle = '#666';
            ctx.font = '8px "Courier New"';
            ctx.fillText('/min', cx, cy + 14);
        }

        function drawAllGauges() {
            const colors = {
                plastic: '#d32f2f',
                steel: '#cfd8dc',
                mold: '#81d4fa',
                part: '#ffd700',
                dollars: '#39ff14'
            };

            // sliding window for responsiveness
            const windowSize = 10;
            const recentHistory = metrics.history.slice(-windowSize);

            const totals = recentHistory.reduce((acc, m) => {
                acc.plastic += m.plastic;
                acc.steel += m.steel;
                acc.mold += m.mold;
                acc.part += m.part;
                acc.dollars += m.dollars;
                return acc;
            }, { plastic: 0, steel: 0, mold: 0, part: 0, dollars: 0 });

            const alpha = 0.25;  // EMA smoothing factor

            ['plastic', 'steel', 'mold', 'part', 'dollars'].forEach(key => {
                const windowLen = recentHistory.length || 1;
                const rawRate = (totals[key] / windowLen) * 60;

                // Apply EMA to the rate for stability
                gaugeEMA[key] = alpha * rawRate + (1 - alpha) * gaugeEMA[key];

                // Track trend direction (use relative threshold for small values)
                const emaDelta = gaugeEMA[key] - gaugePrevEMA[key];
                const deltaThreshold = Math.max(0.1, gaugeEMA[key] * 0.03);  // 3% or 0.1, whichever is larger

                if (emaDelta > deltaThreshold) {
                    gaugeTrendCount[key] = Math.max(1, gaugeTrendCount[key] + 1);  // trending up
                } else if (emaDelta < -deltaThreshold) {
                    gaugeTrendCount[key] = Math.min(-1, gaugeTrendCount[key] - 1);  // trending down
                } else if (gaugeTrendCount[key] > 0 && emaDelta < 0) {
                    gaugeTrendCount[key] = 0;  // was trending up, now reversing
                } else if (gaugeTrendCount[key] < 0 && emaDelta > 0) {
                    gaugeTrendCount[key] = 0;  // was trending down, now reversing
                }
                // Keep trend count if still moving same direction (even if slowly)
                gaugePrevEMA[key] = gaugeEMA[key];

                // Decide whether to update display
                const diff = gaugeEMA[key] - gaugeDisplayed[key];
                const trending = Math.abs(gaugeTrendCount[key]) >= 3;  // sustained trend for 3+ ticks
                const threshold = trending ? 1 : 3;  // lower threshold when trending

                // When EMA rounds to 0, show 0 (clean boundary)
                if (Math.round(gaugeEMA[key]) === 0) {
                    gaugeDisplayed[key] = 0;
                } else if (Math.abs(diff) >= threshold) {
                    gaugeDisplayed[key] = Math.round(gaugeEMA[key]);
                }
                const value = gaugeDisplayed[key];

                // Update peak (dynamic scaling)
                if (value > gaugePeaks[key]) {
                    gaugePeaks[key] = Math.ceil(value / 10) * 10 || 10;
                }

                if (gaugeCtxs[key]) {
                    drawGauge(gaugeCtxs[key], value, gaugePeaks[key], colors[key]);
                }
            });

            // Store smoothed values for graphs
            smoothedHistory.push({
                plastic: gaugeEMA.plastic,
                steel: gaugeEMA.steel,
                mold: gaugeEMA.mold,
                part: gaugeEMA.part,
                dollars: gaugeEMA.dollars
            });
            if (smoothedHistory.length > 60) smoothedHistory.shift();
        }

        // --- Drawing ---
        function draw() {
            ctx.fillStyle = '#1e2430'; ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#263238'; ctx.lineWidth = 1; ctx.beginPath();
            for(let x=0; x<=GRID_W; x++) { ctx.moveTo(x*TILE_SIZE, 0); ctx.lineTo(x*TILE_SIZE, GRID_H*TILE_SIZE); }
            for(let y=0; y<=GRID_H; y++) { ctx.moveTo(0, y*TILE_SIZE); ctx.lineTo(GRID_W*TILE_SIZE, y*TILE_SIZE); }
            ctx.stroke();

            for (let b of buildings) drawBuilding(b);
            for (let i of items) drawItem(i);
            if (gameRunning && mouseGridPos.x >= 0) drawGhost();
            if (inspectedBuilding) {
                ctx.strokeStyle = '#ff0'; ctx.lineWidth = 2; ctx.setLineDash([5, 5]);
                ctx.strokeRect(inspectedBuilding.x * TILE_SIZE, inspectedBuilding.y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
                ctx.setLineDash([]);
            }
            requestAnimationFrame(draw);
        }

        function drawBuilding(b) {
            let cx = b.x * TILE_SIZE + TILE_SIZE/2;
            let cy = b.y * TILE_SIZE + TILE_SIZE/2;
            ctx.save(); ctx.translate(cx, cy);
            ctx.fillStyle = 'rgba(0,0,0,0.5)'; ctx.fillRect(-16, -16, 36, 36); 
            ctx.fillStyle = b.type.color; ctx.fillRect(-18, -18, 36, 36);
            ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.strokeRect(-18, -18, 36, 36);
            ctx.rotate(b.rot * Math.PI/2);

            if (b.type.isArm) {
                ctx.fillStyle = '#222'; ctx.fillRect(-10, -10, 20, 20);

                // Calculate target angle based on delivery direction
                let targetAngle = 0; // default: forward
                if (b.type.canDirectDeliver) {
                    let dirDiff = (b.deliverDir - b.rot + 4) % 4;
                    if (dirDiff === 1) targetAngle = Math.PI / 2; // right (90¬∞)
                    else if (dirDiff === 3) targetAngle = -Math.PI / 2; // left (-90¬∞)
                    // dirDiff === 0 stays at 0 (forward)
                }

                // Swing from -œÄ (behind) to targetAngle (delivery direction)
                let angleOffset = -Math.PI + b.armAnim * (targetAngle + Math.PI);
                ctx.rotate(angleOffset);

                // Scale arm length based on reachDistance (HYPER ARM = 2 tiles)
                const reachDistance = b.type.reachDistance || 1;
                const armLength = 24 * reachDistance;
                const armThickness = Math.min(10, 10 / reachDistance); // Thinner for longer arms
                const handPos = armLength - 2;

                ctx.fillStyle = b.type.color;
                ctx.fillRect(0, -armThickness/2, armLength, armThickness);
                ctx.fillStyle = '#ccc';
                ctx.fillRect(handPos, -6, 6, 12);
                if (b.heldItem) {
                    ctx.save();
                    ctx.translate(armLength, 0);
                    ctx.rotate(-(b.rot*Math.PI/2 + angleOffset));
                    drawItemShape(ctx, b.heldItem);
                    ctx.restore();
                }
            } else if (b.type.id.includes('belt')) {
                // Horizontal Belt Body (aligned with Right arrow)
                ctx.fillStyle = '#222'; 
                ctx.fillRect(-16, -10, 32, 20); 
                
                // Animation offset moving Right (positive X)
                let offset = (Date.now() / 1000 * b.type.transportSpeed * 200) % 8; 
                
                // Draw tread pattern (Vertical lines moving Right)
                ctx.fillStyle = '#1a1a1a';
                for(let i=-16; i<16; i+=8) {
                    let x = i + offset;
                    if(x > 16) x -= 32;
                    ctx.fillRect(x, -8, 2, 16); 
                }
                
                ctx.fillStyle = b.type.id === 'belt_fast' ? '#d32f2f' : '#607d8b';
                ctx.beginPath(); ctx.moveTo(-6,-6); ctx.lineTo(0,0); ctx.lineTo(-6,6); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0,-6); ctx.lineTo(6,0); ctx.lineTo(0,6); ctx.stroke();
            } else {
                ctx.rotate(-b.rot * Math.PI/2);
                ctx.fillStyle = '#fff'; ctx.font = '16px Arial';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(b.type.icon, 0, 0);
                if (b.outputBuffer) {
                    ctx.fillStyle = 'rgba(0,0,0,0.5)';
                    ctx.beginPath(); ctx.arc(0, 0, 10, 0, Math.PI*2); ctx.fill();
                    if(b.outputCount > 1) {
                        ctx.fillStyle='#fff'; ctx.font='9px monospace';
                        ctx.fillText(b.outputCount, 8, -8);
                    }
                    drawItemShape(ctx, b.outputBuffer);
                }
                if ((b.type.id.includes('cnc') || b.type.id.includes('press')) && b.timer > 0) {
                     ctx.fillStyle = '#000'; ctx.fillRect(-18,16,36,6); 
                     ctx.fillStyle = '#39ff14'; ctx.fillRect(-18,16,36*(b.timer/b.type.recipe.time),6); 
                }
                
                // LED Status Lights
                // Position: Bottom Right (relative to center un-rotated)
                // We are unrotated at this point in the stack due to the ctx.rotate above
                let ledX = 14, ledY = 14;
                
                if (b.type.id === 'bin') {
                    // Bin: Flash Green if just sold
                    if (Date.now() - b.lastSoldTime < 200) {
                        ctx.fillStyle = '#39ff14';
                        ctx.shadowBlur = 5; ctx.shadowColor = '#39ff14';
                        ctx.beginPath(); ctx.arc(ledX, ledY, 3, 0, Math.PI*2); ctx.fill();
                        ctx.shadowBlur = 0;
                    }
                } else {
                    let ledColor = '#333'; // Off/Dim
                    
                    // Logic Priority: Red (Error) -> Yellow (Full) -> Green (Working)
                    let error = false;
                    let warning = false;
                    let working = (b.timer > 0);

                    // Error Checks
                    if (b.type.id.includes('press')) {
                        if (b.moldLife <= 0 && b.inventory[ITEM.MOLD] === 0 && b.inventory[ITEM.MOLD_QUAD] === 0) error = true;
                        else if (b.inventory[ITEM.PLASTIC] === 0 && b.moldLife > 0) error = true; 
                    } else if (b.type.id.includes('cnc') && b.inventory[ITEM.STEEL] === 0) {
                        error = true;
                    }

                    // Warning Check
                    // Sources always hold 1, mega machines (CNC/PRESS) hold 5, regular machines hold 1
                    let threshold = b.type.output ? 1 : (b.type.id.includes('mega') ? 5 : 1);
                    if (b.outputBuffer && b.outputCount >= threshold) warning = true;

                    // Blinking Logic
                    let blinkOn = Math.floor(Date.now() / 300) % 2 === 0;

                    if (error) {
                        ledColor = blinkOn ? '#ff0000' : '#550000';
                    } else if (warning) {
                        ledColor = blinkOn ? '#ffff00' : '#555500';
                    } else if (working) {
                        ledColor = '#39ff14';
                    }

                    ctx.fillStyle = ledColor;
                    if (ledColor === '#39ff14' || (blinkOn && (error || warning))) {
                        ctx.shadowBlur = 5; ctx.shadowColor = ledColor;
                    }
                    ctx.beginPath(); ctx.arc(ledX, ledY, 3, 0, Math.PI*2); ctx.fill();
                    ctx.shadowBlur = 0;
                }
            }
            ctx.restore();
        }

        function drawItem(i) {
            let cx = (i.x * TILE_SIZE) + (TILE_SIZE/2), cy = (i.y * TILE_SIZE) + (TILE_SIZE/2);
            let dir = i.exitDir; if (dir === null) dir = i.sourceDir !== null ? (i.sourceDir + 2) % 4 : 0; 
            
            let drawX = cx, drawY = cy;
            
            if (i.progress < 0.5) {
                let sdx=0, sdy=0;
                if(i.sourceDir===0) sdx=1; if(i.sourceDir===1) sdy=1; if(i.sourceDir===2) sdx=-1; if(i.sourceDir===3) sdy=-1;
                let t = (0.5 - i.progress) * 2; 
                drawX = cx + sdx * t * (TILE_SIZE/2);
                drawY = cy + sdy * t * (TILE_SIZE/2);
            } else {
                let edx=0, edy=0;
                if(dir===0) edx=1; if(dir===1) edy=1; if(dir===2) edx=-1; if(dir===3) edy=-1;
                let t = (i.progress - 0.5) * 2;
                drawX = cx + edx * t * (TILE_SIZE/2);
                drawY = cy + edy * t * (TILE_SIZE/2);
            }
            
            ctx.save(); ctx.translate(drawX, drawY); drawItemShape(ctx, i.type); ctx.restore();
        }

        function drawItemShape(ctx, type) {
            if (type === ITEM.PLASTIC) { 
                ctx.fillStyle = C_PLASTIC; ctx.beginPath(); ctx.arc(0,0,6,0,Math.PI*2); ctx.fill();
            } else if (type === ITEM.PART) {
                ctx.fillStyle = C_PART; ctx.beginPath();
                for(let i=0;i<5;i++) {
                    ctx.lineTo(Math.cos((18+i*72)/180*Math.PI)*8, -Math.sin((18+i*72)/180*Math.PI)*8);
                    ctx.lineTo(Math.cos((54+i*72)/180*Math.PI)*3, -Math.sin((54+i*72)/180*Math.PI)*3);
                }
                ctx.fill();
            } else if (type === ITEM.MOLD_QUAD) {
                ctx.fillStyle = '#004d40'; ctx.fillRect(-7,-7,14,14); 
                ctx.fillStyle = '#fff';
                ctx.beginPath(); ctx.arc(-3,-3,1.5,0,Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(3,-3,1.5,0,Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(-3,3,1.5,0,Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(3,3,1.5,0,Math.PI*2); ctx.fill();
            } else {
                ctx.fillStyle = (type === ITEM.MOLD) ? C_MOLD : C_STEEL;
                ctx.fillRect(-6,-6,12,12);
            }
        }

        function drawGhost() {
            let b = Object.values(BUILDINGS).find(b => b.id === selectedTool);
            if (!b) return;
            let cx = mouseGridPos.x * TILE_SIZE + TILE_SIZE/2;
            let cy = mouseGridPos.y * TILE_SIZE + TILE_SIZE/2;

            ctx.save(); ctx.translate(cx, cy);

            ctx.save();
            ctx.rotate(rotation * Math.PI / 2);
            let s = 1 + Math.sin(Date.now()/200)*0.1;
            ctx.scale(s, s);

            // Show pickup/delivery zones at correct distance for HYPER ARM
            const reachDistance = b.reachDistance || 1;
            const reachOffset = TILE_SIZE * reachDistance;

            // Green arrow (delivery zone)
            ctx.fillStyle = 'rgba(0, 255, 0, 0.5)';
            ctx.beginPath();
            ctx.moveTo(reachOffset - 10, -8);
            ctx.lineTo(reachOffset + 2, 0);
            ctx.lineTo(reachOffset - 10, 8);
            ctx.fill();

            // Red circle (pickup zone)
            ctx.fillStyle = 'rgba(255, 0, 0, 0.5)';
            ctx.beginPath();
            ctx.arc(-reachOffset, 0, 4, 0, Math.PI*2);
            ctx.fill();
            ctx.restore();

            ctx.globalAlpha = 0.5;
            ctx.fillStyle = b.color; ctx.fillRect(-18,-18,36,36);
            ctx.strokeStyle = '#fff'; ctx.lineWidth=2; ctx.strokeRect(-18,-18,36,36);
            ctx.restore();
        }

        window.onload = init;

        // ===== FIREWORKS ANIMATION =====
        const fireworksCanvas = document.getElementById('fireworksCanvas');
        const fwCtx = fireworksCanvas.getContext('2d');

        function resizeFireworksCanvas() {
            fireworksCanvas.width = fireworksCanvas.offsetWidth;
            fireworksCanvas.height = fireworksCanvas.offsetHeight;
        }
        resizeFireworksCanvas();

        // Update visual tile size for badges when canvas is CSS-scaled
        function updateVisualTileSize() {
            const gameCanvas = document.getElementById('gameCanvas');
            if (!gameCanvas) return;
            const rect = gameCanvas.getBoundingClientRect();
            const scale = rect.width / gameCanvas.width;
            const visualTileSize = TILE_SIZE * scale;
            document.documentElement.style.setProperty('--tile-size', Math.min(visualTileSize, TILE_SIZE));

            // Hide all badges when they get smaller than 45px
            const badgeSize = visualTileSize * 1.5;
            const badges = document.querySelectorAll('.logo-badge, .year-badge');
            badges.forEach(badge => {
                badge.style.display = badgeSize < 42 ? 'none' : 'flex';
            });
        }

        // Wait for layout to complete before initial size update
        window.addEventListener('load', updateVisualTileSize);
        requestAnimationFrame(updateVisualTileSize);

        window.addEventListener('resize', () => {
            resizeFireworksCanvas();
            updateVisualTileSize();
        });

        const COLORS = ['#B22234', '#FFFFFF', '#3C3B6E']; // USA Red, White, Blue

        class Firework {
            constructor() {
                this.x = Math.random() * fireworksCanvas.width;
                this.y = fireworksCanvas.height;
                this.targetX = this.x + (Math.random() - 0.5) * 200;
                this.targetY = Math.random() * fireworksCanvas.height * 0.4 + 50;
                this.color = COLORS[Math.floor(Math.random() * COLORS.length)];
                this.speed = Math.random() * 2 + 3;
                this.size = Math.random() * 0.7 + 0.5; // 0.5 to 1.2
                this.trail = [];
                this.exploded = false;
                this.particles = [];
            }

            update() {
                if (!this.exploded) {
                    const dx = this.targetX - this.x;
                    const dy = this.targetY - this.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);

                    if (dist < this.speed) {
                        this.explode();
                    } else {
                        this.trail.push({ x: this.x, y: this.y });
                        if (this.trail.length > 10) this.trail.shift();

                        this.x += (dx / dist) * this.speed;
                        this.y += (dy / dist) * this.speed;
                    }
                } else {
                    this.particles.forEach(p => p.update());
                    this.particles = this.particles.filter(p => p.alpha > 0);
                }
            }

            explode() {
                this.exploded = true;
                const particleCount = (Math.random() * 50 + 80) * this.size;
                for (let i = 0; i < particleCount; i++) {
                    this.particles.push(new Particle(this.x, this.y, this.color, this.size));
                }
            }

            draw() {
                if (!this.exploded) {
                    // Draw trail
                    this.trail.forEach((pos, i) => {
                        fwCtx.beginPath();
                        fwCtx.arc(pos.x, pos.y, 1.5, 0, Math.PI * 2);
                        fwCtx.fillStyle = this.color;
                        fwCtx.globalAlpha = i / this.trail.length * 0.3;
                        fwCtx.fill();
                    });

                    // Draw firework
                    fwCtx.globalAlpha = 0.6;
                    fwCtx.beginPath();
                    fwCtx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                    fwCtx.fillStyle = this.color;
                    fwCtx.fill();
                } else {
                    this.particles.forEach(p => p.draw());
                }
            }

            isDone() {
                return this.exploded && this.particles.length === 0;
            }
        }

        class Particle {
            constructor(x, y, color, size) {
                this.x = x;
                this.y = y;
                this.color = color;
                const angle = Math.random() * Math.PI * 2;
                const speed = (Math.random() * 3 + 1.5) * size;
                this.vx = Math.cos(angle) * speed;
                this.vy = Math.sin(angle) * speed;
                this.alpha = 0.6;
                this.gravity = 0.1;
                this.friction = 0.98;
            }

            update() {
                this.vx *= this.friction;
                this.vy *= this.friction;
                this.vy += this.gravity;
                this.x += this.vx;
                this.y += this.vy;
                this.alpha -= 0.015;
            }

            draw() {
                fwCtx.globalAlpha = this.alpha;
                fwCtx.beginPath();
                fwCtx.arc(this.x, this.y, 2, 0, Math.PI * 2);
                fwCtx.fillStyle = this.color;
                fwCtx.fill();
            }
        }

        let fireworks = [];
        let lastFireworkTime = 0;

        function animateFireworks(timestamp) {
            fwCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);

            // Spawn new fireworks randomly
            if (timestamp - lastFireworkTime > Math.random() * 1200 + 800) {
                fireworks.push(new Firework());
                lastFireworkTime = timestamp;
            }

            // Update and draw fireworks
            fireworks.forEach(fw => {
                fw.update();
                fw.draw();
            });

            // Remove finished fireworks
            fireworks = fireworks.filter(fw => !fw.isDone());

            requestAnimationFrame(animateFireworks);
        }

        requestAnimationFrame(animateFireworks);
    </script>

</body></html>